<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mini PvZ - C·ªông m·∫∑t tr·ªùi v√† ƒëi·ªÉm</title>
<style>
  body { background:#9be29b; font-family:sans-serif; user-select:none; }
  h1{text-align:center;}
  #game{
    position:relative;width:980px;height:720px;margin:10px auto;
    background:repeating-linear-gradient(90deg,#7fcf7f 0,#7fcf7f 68px,#72c272 70px),
               repeating-linear-gradient(0deg,#7fcf7f 0,#7fcf7f 88px,#72c272 90px);
    border:4px solid #2a6e2a;
  }
  .plant,.zombie,.bullet{position:absolute;transform:translate(-50%,-50%);text-align:center;font-weight:bold;font-size:12px;}
  .zombie{width:60px;height:80px;background:gray;border:2px solid black;color:white;}
  .zombie.red{background:red;}
  .zombie.big{width:80px;height:100px;background:darkgray;}
  .zombie.purple{width:180px;height:180px;background:purple;font-size:18px;border:3px solid black;}
  .zombie.smart{background:url('thayma.png') center/cover no-repeat;}
  .zombie.thayma2{background:url('thayma2.png') center/cover no-repeat;}
  .zombie.thayma3{background:url('thayma3.png') center/cover no-repeat;}
  .zombie.thayma4{background:url('thayma4.png') center/cover no-repeat;}
  .zombie.thayma5{background:url('thayma5.png') center/cover no-repeat;}
  .zombie.thayma6{background:url('thayma6.png') center/cover no-repeat; width:100px;height:120px;z-index:1000;}
  .bullet{width:10px;height:10px;background:yellow;border-radius:50%;}
  .bullet.green{background:lime;}
  .bullet.blue{background:cyan;}
  .bullet.az{background:orange;}
  .bullet.purple-bullet{background:purple;width:15px;height:15px;}
  /* ƒê·∫°n to m√†u ƒë·ªè c·ªßa boss */
  .bullet.red-boss-bullet{
    background:red;
    width:40px;
    height:40px;
    border-radius:0%;
    border:3px solid darkred;
    z-index: 900;
  }
  /* ƒê·∫°n ƒë∆∞·ª£c tƒÉng c∆∞·ªùng b·ªüi cay12 */
  .bullet.enhanced{
    border:2px solid gold;
    transition: all 0.1s;
  }
  /* ƒê·∫°n c·ªßa ƒë·∫°i b√°c ƒë·ªãa ng·ª•c */
  .bullet.hell-cannon{
    background:purple;
    width:20px;
    height:20px;
    border:2px solid black;
  }
  #panel{text-align:center;margin:10px;}
  button{margin:2px 4px;padding:5px 10px;cursor:pointer;}
  #scoreBoard{
    position:absolute;
    bottom:5px;
    right:15px;
    background:rgba(255,255,255,0.6);
    padding:5px 10px;
    border-radius:8px;
    font-weight:bold;
  }
 body { background:#9be29b; font-family:sans-serif; user-select:none; }
h1 { text-align:center; }

#panel {
  text-align:center;
  margin:5px;
}

.shop-item {
  width: 30px;
  height: 35px;
  margin: 5px;
  display: inline-block;
  text-align: center;
  cursor: pointer;
  position: relative;
}

.shop-item img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng b·ªã m√©o */
  border-radius: 5px;
}

.shop-item[title]:hover::after {
  content: attr(title);
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 3px 6px;
  background-color: rgba(0, 0, 0, 0.7);
  color: white;
  font-size: 12px;
  border-radius: 5px;
  white-space: nowrap;
}

button {
  margin: 2px 4px;
  padding: 5px 10px;
  cursor: pointer;
}

#scoreBoard {
  position: absolute;
  bottom: 5px;
  right: 15px;
  background: rgba(255, 255, 255, 0.6);
  padding: 5px 10px;
  border-radius: 8px;
  font-weight: bold;
}

#game {
  position: relative;
  width: 1400px; /* Chi·ªÅu r·ªông game */
  height: 535px; /* Chi·ªÅu cao game */
  margin: 10px auto;
  background: none;
  border: 4px solid #2a6e2a;
}

.cell {
  width: 70px; /* K√≠ch th∆∞·ªõc √¥ */
  height: 90px; /* K√≠ch th∆∞·ªõc √¥ */
  border: 1px solid #3a923a; /* ƒê∆∞·ªùng vi·ªÅn cho c√°c √¥ */
  display: inline-block;
  box-sizing: border-box;
  position: absolute;
}

.plant, .zombie, .bullet {
  position: absolute;
  transform: translate(-50%, -50%);
  text-align: center;
  font-weight: bold;
  font-size: 12px;
}

/* C√¢y - C·∫§U H√åNH CHUNG */
.plant {
  width: var(--plant-width, 60px);
  height: var(--plant-height, 60px);
  margin: 0;
  position: absolute;
}

/* Thanh mana */
.mana-bar {
  position: absolute;
  bottom: -8px;
  left: 0;
  width: var(--plant-width, 60px);
  height: 5px;
  background: rgba(255, 255, 255, 0.3);
}

.mana-fill {
  height: 100%;
  width: 0%;  /* M·ªü r·ªông thanh mana */
  background: blue;
}
/* S·ªë m√°u */
.hp-text {
  position: absolute;
  top: -15px;  /* Gi·∫£m kho·∫£ng c√°ch ƒë·ªÉ s·ªë m√°u g·∫ßn ƒë·∫ßu c√¢y h∆°n */
  left: 50%;   /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
  transform: translateX(-50%); /* CƒÉn gi·ªØa ho√†n h·∫£o */
  font-size: 14px;
  color: #ff0000;  /* M√†u ƒë·ªè cho s·ªë m√°u */
}
/* Th√™m v√†o ph·∫ßn CSS cho bullet */
.bullet.red { background: red; }

/* Hi·ªáu ·ª©ng cho c√¢y cay14 khi k√≠ch ho·∫°t */
.plant.cay14 {
  transition: box-shadow 0.3s ease;
  border: 2px solid gold;
}

/* Hi·ªáu ·ª©ng cho c√¢y cay16 khi b·ªã t·∫•n c√¥ng */
.plant.cay16.hit {
  animation: mineFlash 0.5s;
  box-shadow: 0 0 20px red;
}

@keyframes mineFlash {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.5); }
}

/* Hi·ªáu ·ª©ng cho zombie khi b·ªã t·∫•n c√¥ng b·ªüi cay14 */
.zombie.hit-by-cay14 {
  animation: hitFlash 0.5s;
}

@keyframes hitFlash {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.5); }
}

/* Hi·ªáu ·ª©ng h·ªìi m√°u */
.heal-effect {
  position: absolute;
  width: 60px;
  height: 60px;
  background: radial-gradient(circle, rgba(0,255,0,0.5) 0%, rgba(0,255,0,0) 70%);
  border-radius: 50%;
  animation: healPulse 1s ease-out;
  pointer-events: none;
  z-index: 500;
}

@keyframes healPulse {
  0% { transform: scale(0.5); opacity: 1; }
  100% { transform: scale(2); opacity: 0; }
}

/* Hi·ªáu ·ª©ng m√¨n n·ªï */
.mine-explosion-effect {
  position: absolute;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(255,0,0,0.7) 0%, rgba(255,0,0,0) 70%);
  border-radius: 50%;
  animation: explosionPulse 0.8s ease-out;
  pointer-events: none;
  z-index: 800;
}

@keyframes explosionPulse {
  0% { transform: scale(0.1); opacity: 1; }
  100% { transform: scale(1.5); opacity: 0; }
}
</style>
</head>
<body>

<div id="timer" style="position: absolute; top: 10px; right: 20px; font-size: 20px; color: white;">00:00</div>
<div id="panel">
  ‚òÄÔ∏è M·∫∑t tr·ªùi: <span id="sun">100</span>
<div class="shop-item" id="sunflower" onclick="selectPlant('sunflower')" title="Gi√°: 50">
  <img src="cay1.png" alt="H∆∞·ªõng d∆∞∆°ng">
</div>
<div class="shop-item" id="bigsun" onclick="selectPlant('bigsun')" title="Gi√°: 500">
  <img src="cay2.png" alt="H∆∞·ªõng d∆∞∆°ng to">
</div>
<div class="shop-item" id="pea" onclick="selectPlant('pea')" title="Gi√°: 100">
  <img src="cay3.png" alt="Pea">
</div>
<div class="shop-item" id="peaice" onclick="selectPlant('peaice')" title="Gi√°: 175">
  <img src="cay4.png" alt="Pea bƒÉng">
</div>
<div class="shop-item" id="pea2" onclick="selectPlant('pea2')" title="Gi√°: 200">
  <img src="cay5.png" alt="Pea 2 ƒë·∫ßu">
</div>
<div class="shop-item" id="wallnut" onclick="selectPlant('wallnut')" title="Gi√°: 15">
  <img src="cay6.png" alt="√ìc ch√≥">
</div>
<div class="shop-item" id="cherry" onclick="selectPlant('cherry')" title="Gi√°: 250">
  <img src="cay7.png" alt="Cherry">
</div>
<div class="shop-item" id="azami" onclick="selectPlant('azami')" title="Gi√°: 1000">
  <img src="cay8.png" alt="Azami">
</div>
<div class="shop-item" id="shovel" onclick="selectPlant('shovel')" title="Gi√°: 0">
  <img src="cay9.png" alt="X·∫ªng">
</div>
<div class="shop-item" id="cay10" onclick="selectPlant('cay10')" title="Gi√°: 1500">
  <img src="cay10.png" alt="C√¢y si√™u b·∫Øn">
</div>
<!-- C√¢y ph·∫£n ƒë·∫°n -->
<div class="shop-item" id="cay11" onclick="selectPlant('cay11')" title="Gi√°: 5000 - Ph·∫£n ƒë·∫°n">
  <img src="cay11.png" alt="C√¢y ph·∫£n ƒë·∫°n">
</div>
<!-- C√¢y tƒÉng c∆∞·ªùng ƒë·∫°n -->
<div class="shop-item" id="cay12" onclick="selectPlant('cay12')" title="Gi√°: 5000 - TƒÉng c∆∞·ªùng ƒë·∫°n">
  <img src="cay12.png" alt="C√¢y tƒÉng c∆∞·ªùng ƒë·∫°n">
</div>
<!-- C√¢y m·ªõi -->
<div class="shop-item" id="cay13" onclick="selectPlant('cay13')" title="Gi√°: 10000 - H·∫Øc di·ªáp th·∫°ch">
  <img src="cay13.png" alt="H·∫Øc di·ªáp th·∫°ch">
</div>
<div class="shop-item" id="cay14" onclick="selectPlant('cay14')" title="Gi√°: 25000 - √ìc ch√≥ si√™u khuy·ªÉn (Gi·∫£m 50% s√°t th∆∞∆°ng, K·ªπ nƒÉng 3x3)">
  <img src="cay14.png" alt="√ìc ch√≥ si√™u khuy·ªÉn">
</div>
<div class="shop-item" id="cay15" onclick="selectPlant('cay15')" title="Gi√°: 20000 - ƒê·∫°i b√°c ƒë·ªãa ng·ª•c">
  <img src="cay15.png" alt="ƒê·∫°i b√°c ƒë·ªãa ng·ª•c">
</div>
<!-- C√¢y m√¨n h·∫Øc di·ªáp th·∫°ch -->
<div class="shop-item" id="cay16" onclick="selectPlant('cay16')" title="Gi√°: 1500 - M√¨n h·∫Øc di·ªáp th·∫°ch (3000 m√°u, h·ªìi 1 HP/s cho to√†n b·ªô c√¢y, khi b·ªã t·∫•n c√¥ng g√¢y 30 s√°t th∆∞∆°ng to√†n s√¢n)">
  <img src="cay16.png" alt="M√¨n h·∫Øc di·ªáp th·∫°ch">
</div>
  <div class="shop-item" id="noSelect" onclick="deselectPlant()" title="Kh√¥ng ch·ªçn c√¢y">
  <img src="no_select_icon.png" alt="Kh√¥ng ch·ªçn c√¢y">
  </div>
  <button id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è T·∫°m d·ª´ng</button>
  <span id="selected"></span>
</div>


<div id="game">
  <div id="scoreBoard">üèÜ ƒêi·ªÉm: <span id="score">0</span></div>
</div>

<audio id="shootSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="boomSound" src="https://actions.google.com/sounds/v1/explosions/explosion.ogg"></audio>
<audio id="dieSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>

<script>
// =============== C·∫§U H√åNH D·ªÑ CH·ªàNH S·ª¨A ===============
const PLANT_CONFIG = {
  defaultSize: {
    width: 60,
    height: 60
  },
  
  plants: {
    sunflower: {
      name: "H∆∞·ªõng d∆∞∆°ng",
      cost: 50,
      hp: 20,
      image: "cay1.png",
      width: 60,
      height: 60,
      action: {
        type: "sunProducer",
        interval: 5000,
        amount: 25
      }
    },
    bigsun: {
      name: "H∆∞·ªõng d∆∞∆°ng to",
      cost: 500,
      hp: 25,
      image: "cay2.png",
      width: 65,
      height: 65,
      action: {
        type: "sunProducer",
        interval: 1000,
        amount: 10
      }
    },
    pea: {
      name: "Pea",
      cost: 100,
      hp: 15,
      image: "cay3.png",
      width: 60,
      height: 60,
      action: {
        type: "shooter",
        interval: 1500,
        bullet: { color: "yellow", power: 2, count: 1 }
      }
    },
    peaice: {
      name: "Pea bƒÉng",
      cost: 175,
      hp: 15,
      image: "cay4.png",
      width: 60,
      height: 60,
      action: {
        type: "shooter",
        interval: 2000,
        bullet: { color: "blue", power: 1, count: 1, freeze: true }
      }
    },
    pea2: {
      name: "Pea 2 ƒë·∫ßu",
      cost: 200,
      hp: 15,
      image: "cay5.png",
      width: 65,
      height: 60,
      action: {
        type: "shooter",
        interval: 2000,
        bullet: { color: "green", power: 2, count: 2 }
      }
    },
    wallnut: {
      name: "√ìc ch√≥",
      cost: 15,
      hp: 500,
      image: "cay6.png",
      width: 70,
      height: 70,
      action: { type: "none" }
    },
    cherry: {
      name: "Cherry",
      cost: 250,
      hp: 10,
      image: "cay7.png",
      width: 60,
      height: 60,
      action: {
        type: "exploder",
        delay: 1500,
        damage: 1000,
        range: 1.5
      }
    },
    azami: {
      name: "Azami",
      cost: 1000,
      hp: 50,
      image: "cay8.png",
      width: 60,
      height: 60,
      action: {
        type: "shooter",
        interval: 700,
        bullet: { color: "az", power: 10, count: 1, knock: true },
        cost: 25
      },
      limitPerRow: 1
    },
    cay10: {
      name: "C√¢y si√™u b·∫Øn",
      cost: 1500,
      hp: 90,
      image: "cay10.png",
      width: 90,
      height: 70,
      action: {
        type: "shooter",
        interval: 4000,
        bullet: { color: "red", power: 30, count: 1 }
      },
      limitPerRow: 1
    },
    shovel: {
      name: "X·∫ªng",
      cost: 0,
      hp: 0,
      image: "cay9.png",
      width: 50,
      height: 50,
      action: { type: "tool" }
    },
    cay11: {
      name: "C√¢y ph·∫£n ƒë·∫°n",
      cost: 5000,
      hp: 10,
      maxHp: 10,
      image: "cay11.png",
      width: 60,
      height: 60,
      action: { type: "reflector" }
    },
    cay12: {
      name: "C√¢y tƒÉng c∆∞·ªùng ƒë·∫°n",
      cost: 5000,
      hp: 50,
      image: "cay12.png",
      width: 60,
      height: 60,
      action: { type: "enhancer" }
    },
    cay13: {
      name: "H·∫Øc di·ªáp th·∫°ch",
      cost: 10000,
      hp: 1700,
      maxHp: 1700,
      image: "cay13.png",
      width: 70,
      height: 70,
      action: { 
        type: "blocker",
        healPerSecond: 30
      }
    },
    cay14: {
      name: "√ìc ch√≥ si√™u khuy·ªÉn",
      cost: 25000,
      hp: 8000,
      maxHp: 8000,
      image: "cay14.png",
      width: 80,
      height: 80,
      action: {
        type: "areaHealer",
        interval: 3000,
        damage: 100,
        range: 1,
        healMultiplier: 1.0,
        damageReduction: 0.5
      }
    },
    cay15: {
      name: "ƒê·∫°i b√°c ƒë·ªãa ng·ª•c",
      cost: 20000,
      hp: 600,
      image: "cay15.png",
      width: 70,
      height: 70,
      action: {
        type: "hellCannon",
        interval: 800,
        bullet: { color: "hell-cannon", power: 10, count: 1, knock: true }
      }
    },
    cay16: {
      name: "M√¨n h·∫Øc di·ªáp th·∫°ch",
      cost: 1500,
      hp: 3000,
      maxHp: 3000,
      image: "cay16.png",
      width: 60,
      height: 60,
      action: {
        type: "mine",
        healPerSecond: 1,
        explosionDamage: 30,
        explosionOnHit: true
      }
    }
  }
};

// =============== C·∫§U H√åNH TH√ÇY MA D·ªÑ CH·ªàNH S·ª¨A ===============
const ZOMBIE_CONFIG = {
  attackInterval: 1000,
  
  zombies: {
    normal: {
      name: "Th√¢y ma th∆∞·ªùng",
      baseHp: 12,
      speed: 0.01,
      attackDamage: 2,
      sunReward: 25,
      scoreReward: 1
    },
    red: {
      name: "Th√¢y ma ƒë·ªè",
      baseHp: 12,
      speed: 0.007,
      attackDamage: 3,
      hpBonusPerKill: 5,
      sunReward: 25,
      scoreReward: 1
    },
    big: {
      name: "Th√¢y ma to",
      baseHp: 20,
      speed: 0.0025,
      attackDamage: 5,
      sunReward: 25,
      scoreReward: 1
    },
    smart: {
      name: "Th√¢y ma th√¥ng minh",
      baseHp: 20,
      speed: 0.013,
      attackDamage: 3,
      sunReward: 25,
      scoreReward: 1
    },
    purple: {
      name: "Boss",
      baseHp: 500,
      speed: 0.001,
      attackDamage: 10,
      sunReward: 25,
      scoreReward: 1
    },
    thayma2: {
      name: "Th√¢y ma 2 - ƒêi xuy√™n qua c√¢y",
      baseHp: 100,
      speed: 0.015,
      attackDamage: 0,
      canAttack: false,
      passThroughPlants: true,
      sunReward: 50,
      scoreReward: 3
    },
    thayma3: {
      name: "Th√¢y ma 3 - Ch·∫∑n ƒë∆∞·ªùng",
      baseHp: 3000,
      speed: 0.02,
      attackDamage: 0,
      canAttack: false,
      stopsAtPlant: true,
      sunReward: 75,
      scoreReward: 5
    },
    thayma4: {
      name: "Th√¢y ma 4 - Bom n·ªï",
      baseHp: 500,
      speed: 0.0015,
      attackDamage: 999,
      explosionOnDeath: true,
      explosionRange: 1.5,
      sunReward: 100,
      scoreReward: 10
    },
    thayma5: {
      name: "Th√¢y ma 5 - Chi·∫øn binh b·∫•t kh·∫£ chi·∫øn b·∫°i",
      baseHp: 8000,
      speed: 0.018,
      attackDamage: 5,
      immuneToControl: true,
      immuneToKnockback: true,
      canAttack: true,
      sunReward: 150,
      scoreReward: 15
    },
    thayma6: {
      name: "Th√¢y ma 6 - Qu√°i v·∫≠t t·ªëi th∆∞·ª£ng",
      baseHp: 50000,
      speed: 0.01,
      attackDamage: 0,
      canAttack: false,
      immuneToControl: true,
      immuneToKnockback: true,
      immuneToExplosion: true,
      stopsAtDistance: 2,
      rangedAttack: true,
      rangedDamage: 200,
      rangedInterval: 5000,
      rangedTarget: "first",
      sunReward: 1000,
      scoreReward: 100,
      winOnKill: true
    }
  },
  
  timeUpdates: {
    interval: 30,
    hpIncrease: 10,
    speedIncrease: 0.01
  }
};

const rows = 8;
const cols = 20;
const game=document.getElementById("game");
const sunSpan=document.getElementById("sun");
const scoreSpan=document.getElementById("score");
let sun=100,score=0;
let selectedPlant=null;
let plants=[],zombies=[],bullets=[];
let zombieSpawnRate=3000,zombieCount=0,redKills=0,bossSpawned=false;
let paused=false;
let startTime = Date.now();
let lastUpdateTime = 0;
let elapsedTime = 0;

// Bi·∫øn ƒëi·ªÅu khi·ªÉn spawn c√°c lo·∫°i th√¢y ma ƒë·∫∑c bi·ªát
let thayma2Spawned = false;
let thayma3Spawned = false;
let thayma4Spawned = false;
let thayma5Spawned = false;
let thayma6Spawned = false;
const THAYMA2_SPAWN_TIME = 45;
const THAYMA3_SPAWN_TIME = 60;
const THAYMA4_SPAWN_TIME = 90;
const THAYMA5_SPAWN_TIME = 120;
const THAYMA6_SPAWN_TIME = 60;

function selectPlant(t){selectedPlant=t;document.getElementById("selected").textContent="‚Üí "+t;}
function cellPos(r, c) {
  return {
    x: c * 70 + 35,
    y: r * 90 + 45
  };
}
function togglePause(){
 paused=!paused;
 document.getElementById("pauseBtn").textContent=paused?"‚ñ∂Ô∏è Ti·∫øp t·ª•c":"‚è∏Ô∏è T·∫°m d·ª´ng";
}

game.onclick = (e) => {
  if (!selectedPlant || paused) return;
  const rect = game.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  const c = Math.floor(x / 70), r = Math.floor(y / 90);

  const exist = plants.find(p => p.r === r && p.c === c);
  if (selectedPlant === 'shovel') {
    if (exist) {
      exist.el.remove();
      plants = plants.filter(p => p !== exist);
      const config = PLANT_CONFIG.plants[exist.type];
      sun += Math.floor(config.cost * 0.5);
      sunSpan.textContent = sun;
    }
    return;
  }

  if (exist) return;
  
  const config = PLANT_CONFIG.plants[selectedPlant];
  if (!config || sun < config.cost) return;
  
  // Ki·ªÉm tra gi·ªõi h·∫°n s·ªë c√¢y m·ªói h√†ng cho azami v√† cay10
  if (selectedPlant === 'azami' || selectedPlant === 'cay10') {
    const plantsInRow = plants.filter(p => p.r === r && p.type === selectedPlant);
    if (plantsInRow.length >= (config.limitPerRow || 1)) {
      alert(`M·ªói h√†ng ch·ªâ ƒë∆∞·ª£c tr·ªìng t·ªëi ƒëa ${config.limitPerRow} c√¢y ${config.name}!`);
      return;
    }
  }
  
  sun -= config.cost;
  sunSpan.textContent = sun;
  
  addPlant(r, c, selectedPlant);
}

function deselectPlant() {
  selectedPlant = null;
  document.getElementById("selected").textContent = "‚Üí Kh√¥ng ch·ªçn c√¢y";
}

function addPlant(r, c, type) {
  const config = PLANT_CONFIG.plants[type];
  if (!config) return;

  const el = document.createElement("div");
  el.className = "plant " + type;
  const pos = cellPos(r, c);
  el.style.left = pos.x + "px";
  el.style.top = pos.y + "px";
  
  el.style.setProperty('--plant-width', config.width + 'px');
  el.style.setProperty('--plant-height', config.height + 'px');
  el.style.width = config.width + 'px';
  el.style.height = config.height + 'px';

  const plantImage = document.createElement("img");
  plantImage.src = config.image;
  plantImage.alt = config.name;
  plantImage.style.width = "100%";
  plantImage.style.height = "100%";
  el.appendChild(plantImage);

  const hpT = document.createElement("div");
  hpT.className = "hp-text";
  hpT.textContent = config.hp;
  el.appendChild(hpT);

  const manaBar = document.createElement("div");
  manaBar.className = "mana-bar";
  const manaFill = document.createElement("div");
  manaFill.className = "mana-fill";
  manaBar.appendChild(manaFill);
  el.appendChild(manaBar);

  game.appendChild(el);

  const p = {
    r,
    c,
    type,
    hp: config.hp,
    maxHp: config.hp,
    el,
    hpT,
    mana: 0,
    manaFill,
    config: config,
    lastAction: Date.now(),
    lastHealTime: Date.now(),
    lastHitTime: 0,
    cooldown: false,
    reflectionCount: 0,
    lastSkillTime: Date.now()
  };

  plants.push(p);

  setInterval(() => {
    if (p.type === "sunflower" || p.type === "bigsun") {
      if (p.mana < 100) {
        p.mana += 25;
        p.manaFill.style.width = Math.min(100, p.mana) + "%";
      } else {
        sun += 50;
        sunSpan.textContent = sun;
        p.mana = 0;
        p.manaFill.style.width = "0%";
      }
    }
  }, 1000);

  if (type === "cherry") setTimeout(() => explode(p), 1500);
}

function explode(p){
 if(paused)return;
 document.getElementById("boomSound").play();
 
 const config = p.config.action;
 const damage = config.damage || 999;
 const range = config.range || 1.5;
 
 zombies.forEach(z=>{
   if (z.type === "thayma6" && z.config.immuneToExplosion) return;
   
   if(Math.abs(z.r - p.r) <= range && Math.abs(z.x - p.c) < range) {
     z.hp -= damage;
   }
 });
 
 p.el.remove();
 plants = plants.filter(x=>x!==p);
}

// H√†m t·∫°o hi·ªáu ·ª©ng h·ªìi m√°u
function createHealEffect(x, y) {
  const healEl = document.createElement("div");
  healEl.className = "heal-effect";
  healEl.style.left = x + "px";
  healEl.style.top = y + "px";
  game.appendChild(healEl);
  
  setTimeout(() => {
    if (healEl.parentNode) {
      healEl.parentNode.removeChild(healEl);
    }
  }, 1000);
}

// H√†m t·∫°o hi·ªáu ·ª©ng m√¨n n·ªï
function createMineExplosionEffect(x, y) {
  const explosionEl = document.createElement("div");
  explosionEl.className = "mine-explosion-effect";
  explosionEl.style.left = x + "px";
  explosionEl.style.top = y + "px";
  game.appendChild(explosionEl);
  
  setTimeout(() => {
    if (explosionEl.parentNode) {
      explosionEl.parentNode.removeChild(explosionEl);
    }
  }, 800);
}

function spawnZombie() {
  if (paused) {
    setTimeout(spawnZombie, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  const r = Math.floor(Math.random() * 5);
  
  let type = "normal";
  if (elapsed > 30 && Math.random() < 0.15) type = "red";
  if (elapsed > 60 && Math.random() < 0.05) type = "big";

  const z = document.createElement("div");
  z.className = "zombie " + (type === "red" ? "red" : type === "big" ? "big" : "");
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies[type];
  let hp = config.baseHp;
  if (type === "red") hp += 5 * Math.min(zombieCount, 10);
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type, 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack || true,
    config: config,
    immuneToControl: config.immuneToControl || false,
    immuneToKnockback: config.immuneToKnockback || false,
    immuneToExplosion: config.immuneToExplosion || false,
    passThroughPlants: config.passThroughPlants || false
  };
  
  zombies.push(zombie);
  zombieCount++;
  setTimeout(spawnZombie, 3000);
}

function spawnThayMa2() {
  if (paused || thayma2Spawned) {
    setTimeout(spawnThayMa2, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA2_SPAWN_TIME) {
    setTimeout(spawnThayMa2, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma2";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma2;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma2", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    passThroughPlants: config.passThroughPlants,
    config: config
  };

  zombies.push(zombie);
  thayma2Spawned = true;
  
  setTimeout(() => {
    thayma2Spawned = false;
    setTimeout(spawnThayMa2, 30000);
  }, 30000);
}

function spawnThayMa3() {
  if (paused || thayma3Spawned) {
    setTimeout(spawnThayMa3, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA3_SPAWN_TIME) {
    setTimeout(spawnThayMa3, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma3";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma3;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma3", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    stopsAtPlant: config.stopsAtPlant,
    stopped: false,
    stuck: false,
    config: config
  };

  zombies.push(zombie);
  thayma3Spawned = true;
  
  setTimeout(() => {
    thayma3Spawned = false;
    setTimeout(spawnThayMa3, 45000);
  }, 45000);
}

function spawnThayMa4() {
  if (paused || thayma4Spawned) {
    setTimeout(spawnThayMa4, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA4_SPAWN_TIME) {
    setTimeout(spawnThayMa4, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma4";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma4;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma4", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: true,
    explosionOnDeath: config.explosionOnDeath,
    explosionRange: config.explosionRange,
    config: config
  };

  zombies.push(zombie);
  thayma4Spawned = true;
  
  setTimeout(() => {
    thayma4Spawned = false;
    setTimeout(spawnThayMa4, 60000);
  }, 60000);
}

function spawnThayMa5() {
  if (paused || thayma5Spawned) {
    setTimeout(spawnThayMa5, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA5_SPAWN_TIME) {
    setTimeout(spawnThayMa5, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma5";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma5;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma5", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    immuneToControl: config.immuneToControl,
    immuneToKnockback: config.immuneToKnockback,
    config: config
  };

  zombies.push(zombie);
  thayma5Spawned = true;
  
  setTimeout(() => {
    thayma5Spawned = false;
    setTimeout(spawnThayMa5, 60000);
  }, 60000);
}

function spawnThayMa6() {
  if (paused || thayma6Spawned) {
    setTimeout(spawnThayMa6, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA6_SPAWN_TIME) {
    setTimeout(spawnThayMa6, 1000);
    return;
  }
  
  const r = 3;
  const z = document.createElement("div");
  z.className = "zombie thayma6";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma6;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-25px";
  hpT.style.fontSize = "16px";
  hpT.style.color = "gold";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma6", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    lastRangedAttack: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    immuneToControl: config.immuneToControl,
    immuneToKnockback: config.immuneToKnockback,
    immuneToExplosion: config.immuneToExplosion,
    stopsAtDistance: config.stopsAtDistance,
    hasStopped: false,
    rangedAttack: config.rangedAttack,
    rangedDamage: config.rangedDamage,
    rangedInterval: config.rangedInterval,
    rangedTarget: config.rangedTarget,
    winOnKill: config.winOnKill,
    config: config
  };

  zombies.push(zombie);
  thayma6Spawned = true;
}

function spawnSmartZombie(){
 if(paused){setTimeout(spawnSmartZombie,1000);return;}
 if(plants.length===0){setTimeout(spawnSmartZombie,5000);return;}
 let rowCount=new Array(rows).fill(0);
 plants.forEach(p=>rowCount[p.r]++);
 const maxCount=Math.max(...rowCount);
 const candidates=[];rowCount.forEach((c,i)=>{if(c===maxCount)candidates.push(i);});
 const targetRow=candidates[Math.floor(Math.random()*candidates.length)];
 const z=document.createElement("div");
 z.className="zombie smart";
 const pos=cellPos(targetRow,cols);
 z.style.left=pos.x+"px";z.style.top=pos.y+"px";
 
 const config = ZOMBIE_CONFIG.zombies.smart;
 const hp = config.baseHp;
 
 const hpT=document.createElement("div");
 hpT.style.position="absolute";
 hpT.style.top="-20px";
 hpT.textContent=hp;
 z.appendChild(hpT);
 game.appendChild(z);
 
 const zombie={
   r:targetRow,
   x:cols,
   hp,
   type:"smart",
   speed:config.speed,
   el:z,
   hpT,
   attack:null,
   slow:1,
   lastAttackTime: 0,
   attackDamage: config.attackDamage,
   canAttack: true,
   config: config
 };
 zombies.push(zombie);
 setTimeout(spawnSmartZombie,5000);
}

function spawnBoss(){
 if(bossSpawned)return;bossSpawned=true;
 const r=Math.floor(rows/2);
 const z=document.createElement("div");
 z.className="zombie purple";
 const pos=cellPos(r,cols);
 z.style.left=pos.x+"px";
 z.style.top=pos.y+"px";
 
 const config = ZOMBIE_CONFIG.zombies.purple;
 const hp = config.baseHp;
 
 const hpT=document.createElement("div");
 hpT.style.position="absolute";
 hpT.style.top="-25px";
 hpT.textContent=hp;
 z.appendChild(hpT);
 game.appendChild(z);
 
 zombies.push({
   r,
   x:cols,
   hp,
   type:"purple",
   speed:config.speed,
   el:z,
   hpT,
   attack:null,
   slow:1,
   lastAttackTime: 0,
   attackDamage: config.attackDamage,
   canAttack: true,
   config: config
 });
}

function update() {
  if (paused) return;

  elapsedTime = Math.floor((Date.now() - startTime) / 1000);
  
  const minutes = Math.floor(elapsedTime / 60);
  const seconds = elapsedTime % 60;
  document.getElementById('timer').textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

  if (elapsedTime - lastUpdateTime >= ZOMBIE_CONFIG.timeUpdates.interval) {
    zombies.forEach(z => {
      if (z.type !== "thayma5" && z.type !== "thayma6") {
        z.hp += ZOMBIE_CONFIG.timeUpdates.hpIncrease;
        z.speed += ZOMBIE_CONFIG.timeUpdates.speedIncrease;
        z.hpT.textContent = Math.ceil(z.hp);
      }
    });
    lastUpdateTime = elapsedTime;
  }

  zombies.forEach(z => {
    if (z.type === "thayma6" && !z.hasStopped) {
      if (z.x <= cols - z.stopsAtDistance) {
        z.hasStopped = true;
        z.speed = 0;
      }
    }
    
    const targetPlant = plants.find(p => p.r === z.r && Math.abs(p.c - z.x) < 0.5);
    
    if (z.type === "thayma2" && z.passThroughPlants) {
      z.x -= z.speed * z.slow;
      const pos = cellPos(z.r, z.x);
      z.el.style.left = pos.x + "px";
    }
    else if (targetPlant) {
      // √Åp d·ª•ng gi·∫£m s√°t th∆∞∆°ng cho cay14
      let actualDamage = z.attackDamage;
      if (targetPlant.type === "cay14") {
        const config = targetPlant.config;
        actualDamage *= (1 - (config.action.damageReduction || 0));
      }
      
      if (targetPlant.type === "cay13") {
        z.x = Math.max(z.x, targetPlant.c + 0.5);
        const pos = cellPos(z.r, z.x);
        z.el.style.left = pos.x + "px";
      } else {
        if (z.type === "thayma3" && z.stopsAtPlant && !z.stopped) {
          const safeDistance = 0.8;
          if (Math.abs(targetPlant.c - z.x) <= safeDistance) {
            z.stopped = true;
            z.stuck = false;
            z.x = targetPlant.c - safeDistance;
            const pos = cellPos(z.r, z.x);
            z.el.style.left = pos.x + "px";
          }
        }
        
        if (z.canAttack && z.type !== "thayma3" && z.type !== "thayma6") {
          const now = Date.now();
          if (now - z.lastAttackTime > ZOMBIE_CONFIG.attackInterval) {
            // X·ª≠ l√Ω khi zombie t·∫•n c√¥ng c√¢y cay16 (m√¨n)
            if (targetPlant.type === "cay16" && targetPlant.config.action.explosionOnHit) {
              const now = Date.now();
              // Ki·ªÉm tra cooldown cho m√¨n (tr√°nh n·ªï li√™n t·ª•c)
              if (now - targetPlant.lastHitTime > 1000) {
                // K√≠ch ho·∫°t hi·ªáu ·ª©ng m√¨n n·ªï
                const pos = cellPos(targetPlant.r, targetPlant.c);
                createMineExplosionEffect(pos.x, pos.y);
                document.getElementById("boomSound").play();
                
                // G√¢y s√°t th∆∞∆°ng cho t·∫•t c·∫£ zombie tr√™n s√¢n
                const explosionDamage = targetPlant.config.action.explosionDamage || 30;
                zombies.forEach(zombie => {
                  // Tr·ª´ th√¢y ma t·ªëi th∆∞·ª£ng kh·ªèi hi·ªáu ·ª©ng n·ªï n·∫øu n√≥ mi·ªÖn nhi·ªÖm
                  if (!(zombie.type === "thayma6" && zombie.config.immuneToExplosion)) {
                    zombie.hp -= explosionDamage;
                    
                    // Hi·ªáu ·ª©ng tr·ª±c quan cho zombie b·ªã t·∫•n c√¥ng
                    zombie.el.style.boxShadow = "0 0 10px orange";
                    setTimeout(() => {
                      if (zombie.el) zombie.el.style.boxShadow = "";
                    }, 300);
                  }
                });
                
                // Hi·ªáu ·ª©ng tr·ª±c quan cho m√¨n
                targetPlant.el.classList.add("hit");
                setTimeout(() => {
                  if (targetPlant.el) targetPlant.el.classList.remove("hit");
                }, 500);
                
                targetPlant.lastHitTime = now;
              }
            }
            
            targetPlant.hp -= actualDamage;
            targetPlant.hpT.textContent = Math.ceil(targetPlant.hp);
            z.lastAttackTime = now;
            
            if (targetPlant.hp <= 0) {
              targetPlant.el.remove();
              plants = plants.filter(p => p !== targetPlant);
              z.attack = null;
              if (z.type === "thayma3") {
                z.stopped = false;
                z.stuck = false;
              }
            }
          }
        }
        
        if (z.canAttack || (z.type === "thayma3" && z.stopped) || (z.type === "thayma6" && z.hasStopped)) {
          z.x = z.x;
        }
      }
    } else {
      if (!(z.type === "thayma3" && z.stopped) && !(z.type === "thayma6" && z.hasStopped)) {
        z.x -= z.speed * z.slow;
        const pos = cellPos(z.r, z.x);
        z.el.style.left = pos.x + "px";
        
        if (z.type === "thayma3") {
          z.stuck = false;
        }
      }
    }
    
    if (z.type === "thayma3" && z.stopped) {
      const currentTarget = plants.find(p => p.r === z.r && Math.abs(p.c - z.x) < 1.5);
      if (!currentTarget) {
        z.stopped = false;
        z.stuck = false;
      } else {
        z.stuck = false;
      }
    }
    
    if (z.type === "thayma6" && z.rangedAttack && z.hasStopped) {
      const now = Date.now();
      if (now - z.lastRangedAttack > z.rangedInterval) {
        const targetRow = Math.floor(Math.random() * 5);
        
        const bullet = document.createElement("div");
        bullet.className = "bullet red-boss-bullet";
        const pos = cellPos(targetRow, z.x);
        bullet.style.left = pos.x + "px";
        bullet.style.top = pos.y + "px";
        game.appendChild(bullet);
        
        bullets.push({ 
          r: targetRow, 
          x: z.x, 
          el: bullet, 
          power: z.rangedDamage,
          direction: -1,
          speed: 0.25,
          source: "zombie"
        });
        
        z.lastRangedAttack = now;
        document.getElementById("shootSound").play();
      }
    }
    
    z.hpT.textContent = Math.ceil(z.hp);
  });

  plants.forEach(p => {
    const now = Date.now();
    const config = p.config;
    
    // X·ª≠ l√Ω cay13 - H·∫Øc di·ªáp th·∫°ch
    if (p.type === "cay13") {
      if (now - p.lastHealTime > 1000) {
        p.hp = Math.min(p.maxHp, p.hp + (config.action.healPerSecond || 30));
        p.hpT.textContent = Math.ceil(p.hp);
        p.lastHealTime = now;
      }
    }
    
    // X·ª≠ l√Ω cay14 - √ìc ch√≥ si√™u khuy·ªÉn
    if (p.type === "cay14") {
      if (now - p.lastSkillTime > (config.action.interval || 3000)) {
        let totalDamage = 0;
        const range = config.action.range || 1;
        
        zombies.forEach(z => {
          if (Math.abs(z.r - p.r) <= range && Math.abs(z.x - p.c) <= range) {
            z.hp -= config.action.damage;
            totalDamage += config.action.damage;
            
            z.el.style.boxShadow = "0 0 10px red";
            setTimeout(() => {
              if (z.el) z.el.style.boxShadow = "";
            }, 500);
          }
        });
        
        if (totalDamage > 0) {
          const healAmount = totalDamage * config.action.healMultiplier;
          
          plants.forEach(plant => {
            if (plant !== p) {
              const oldHp = plant.hp;
              plant.hp = Math.min(plant.maxHp || plant.hp, plant.hp + healAmount);
              plant.hpT.textContent = Math.ceil(plant.hp);
              
              if (plant.hp > oldHp) {
                const pos = cellPos(plant.r, plant.c);
                createHealEffect(pos.x, pos.y);
              }
            }
          });
          
          p.el.style.boxShadow = "0 0 20px gold";
          setTimeout(() => {
            if (p.el) p.el.style.boxShadow = "";
          }, 1000);
        }
        
        p.lastSkillTime = now;
      }
    }
    
    // X·ª≠ l√Ω cay16 - M√¨n h·∫Øc di·ªáp th·∫°ch
    if (p.type === "cay16") {
      // H·ªìi m√°u cho to√†n b·ªô c√¢y tr√™n s√¢n m·ªói gi√¢y
      if (now - p.lastHealTime > 1000) {
        plants.forEach(plant => {
          if (plant !== p) { // Kh√¥ng t·ª± h·ªìi m√°u cho ch√≠nh m√¨nh
            const oldHp = plant.hp;
            plant.hp = Math.min(plant.maxHp || plant.hp, plant.hp + (config.action.healPerSecond || 1));
            plant.hpT.textContent = Math.ceil(plant.hp);
            
            // T·∫°o hi·ªáu ·ª©ng h·ªìi m√°u nh·∫π
            if (plant.hp > oldHp) {
              const pos = cellPos(plant.r, plant.c);
              // Ch·ªâ hi·ªÉn th·ªã hi·ªáu ·ª©ng cho 1 c√¢y ng·∫´u nhi√™n m·ªói l·∫ßn ƒë·ªÉ tr√°nh lag
              if (Math.random() < 0.1) {
                createHealEffect(pos.x, pos.y);
              }
            }
          }
        });
        
        p.lastHealTime = now;
      }
    }
    
    // X·ª≠ l√Ω cay15 - ƒê·∫°i b√°c ƒë·ªãa ng·ª•c
    if (p.type === "cay15") {
      if (now - p.lastAction > (config.action.interval || 800)) {
        const bulletConfig = config.action.bullet;
        const b = document.createElement("div");
        b.className = "bullet " + bulletConfig.color;
        const pos = cellPos(p.r, p.c);
        b.style.left = (pos.x + 15) + "px";
        b.style.top = pos.y + "px";
        game.appendChild(b);
        
        bullets.push({
          r: p.r,
          x: p.c,
          el: b,
          power: bulletConfig.power,
          knock: bulletConfig.knock || false,
          direction: 1,
          enhanced: false,
          enhancedBy: []
        });
        
        p.lastAction = now;
        document.getElementById("shootSound").play();
      }
    }
    
    if (!config.action) return;
    
    if (p.cooldown) return;
    
    if (config.action.type === "sunProducer") {
      if (now - p.lastAction > config.action.interval) {
        sun += config.action.amount;
        sunSpan.textContent = sun;
        p.lastAction = now;
      }
    }
    
    if (config.action.type === "shooter") {
      if (now - p.lastAction > config.action.interval) {
        fireWithMana(p, () => {
          const bulletConfig = config.action.bullet;
          if (config.action.cost && sun >= config.action.cost) {
            sun -= config.action.cost;
            sunSpan.textContent = sun;
          }
          shoot(p, bulletConfig.count, bulletConfig.color, bulletConfig.power, 
                bulletConfig.freeze || false, bulletConfig.knock || false);
        });
      }
    }
  });

  // Di chuy·ªÉn v√† x·ª≠ l√Ω ƒë·∫°n
  bullets.forEach(b => {
    // X·ª≠ l√Ω ƒë·∫°n ƒëi qua c√¢y tƒÉng c∆∞·ªùng (cay12)
    if (b.direction === 1 && !b.source) {
      plants.forEach(p => {
        if (p.type === "cay12" && p.r === b.r && Math.abs(b.x - p.c) < 0.5) {
          const plantId = `${p.r}-${p.c}`;
          
          if (!b.enhancedBy) {
            b.enhancedBy = [];
          }
          
          if (!b.enhancedBy.includes(plantId)) {
            b.power *= 3;
            
            const currentWidth = parseInt(b.el.style.width) || 10;
            const currentHeight = parseInt(b.el.style.height) || 10;
            
            b.el.style.width = (currentWidth * 2) + "px";
            b.el.style.height = (currentHeight * 2) + "px";
            
            b.el.className += " enhanced";
            b.enhanced = true;
            
            b.enhancedBy.push(plantId);
          }
        }
      });
    }
    
    // ƒê·∫°n c·ªßa boss di chuy·ªÉn t·ª´ ph·∫£i sang tr√°i
    if (b.direction === -1) {
      b.x -= b.speed || 0.25;
      const pos = cellPos(b.r, b.x);
      b.el.style.left = pos.x + "px";
      
      let reflected = false;
      plants.forEach(p => {
        if (p.type === "cay11" && p.r === b.r && Math.abs(b.x - p.c) < 0.5 && !reflected) {
          p.hp -= 1;
          p.hpT.textContent = Math.ceil(p.hp);
          p.reflectionCount++;
          
          const newBullet = document.createElement("div");
          newBullet.className = b.el.className;
          const pos = cellPos(p.r, p.c);
          newBullet.style.left = pos.x + "px";
          newBullet.style.top = pos.y + "px";
          game.appendChild(newBullet);
          
          bullets.push({
            r: p.r,
            x: p.c,
            el: newBullet,
            power: b.power,
            direction: 1,
            speed: 0.2,
            source: "reflected",
            enhanced: b.enhanced,
            enhancedBy: b.enhancedBy ? [...b.enhancedBy] : []
          });
          
          reflected = true;
          
          b.el.remove();
          bullets = bullets.filter(x => x !== b);
          
          if (p.hp <= 0) {
            sun += 1000;
            sunSpan.textContent = sun;
            p.el.remove();
            plants = plants.filter(pl => pl !== p);
          }
        }
      });
      
      if (!reflected) {
        let hitPlant = false;
        plants.forEach(p => {
          if (p.r === b.r && Math.abs(b.x - p.c) < 0.5 && !hitPlant && p.type !== "cay11") {
            p.hp -= b.power;
            p.hpT.textContent = Math.ceil(p.hp);
            hitPlant = true;
            
            if (p.hp <= 0) {
              p.el.remove();
              plants = plants.filter(pl => pl !== p);
            }
          }
        });
        
        if (hitPlant || b.x < 0) {
          b.el.remove();
          bullets = bullets.filter(x => x !== b);
        }
      }
    } else {
      // ƒê·∫°n c·ªßa c√¢y di chuy·ªÉn t·ª´ tr√°i sang ph·∫£i
      b.x += 0.2;
      const pos = cellPos(b.r, b.x);
      b.el.style.left = pos.x + "px";
    }
  });

  // Ki·ªÉm tra ƒë·∫°n c·ªßa c√¢y b·∫Øn v√†o zombie
  bullets.forEach(b => {
    if (b.direction === 1) {
      zombies.forEach(z => {
        if (z.type === "thayma5" || z.type === "thayma6") {
          let hitRange = (z.type === "purple" ? 1.2 : 0.3);
          if (z.r === b.r && Math.abs(z.x - b.x) < hitRange) {
            z.hp -= b.power;
            b.el.remove(); 
            bullets = bullets.filter(x => x !== b);
          }
        } else {
          let hitRange = (z.type === "purple" ? 1.2 : 0.3);
          if (z.r === b.r && Math.abs(z.x - b.x) < hitRange) {
            if (z.type === "thayma3" && z.stuck) {
              z.stuck = false;
            }
            
            z.hp -= b.power;
            if (b.freeze && !z.frozen) { 
              if (!z.immuneToControl) {
                z.slow = Math.max(0.01, z.slow - 0.1); 
                z.frozen = true; 
              }
            }
            if (b.knock) { 
              if (!z.immuneToKnockback) {
                z.x += 0.2; 
              }
            }
            b.el.remove(); 
            bullets = bullets.filter(x => x !== b);
          }
        }
      });
    }
  });

  zombies = zombies.filter(z => {
    if (z.hp <= 0) {
      document.getElementById("dieSound").play();
      const config = ZOMBIE_CONFIG.zombies[z.type];
      
      if (z.type === "thayma4" && z.explosionOnDeath) {
        document.getElementById("boomSound").play();
        zombies.forEach(otherZombie => {
          if (otherZombie.r === z.r && otherZombie !== z) {
            otherZombie.hp = 0;
          }
        });
      }
      
      if (z.type === "thayma6" && z.winOnKill) {
        alert("üéâ B·∫†N ƒê√É CHI·∫æN TH·∫ÆNG! ƒê√É TI√äU DI·ªÜT TH√ÇY MA T·ªêI TH∆Ø·ª¢NG! üéâ\nT·ªïng ƒëi·ªÉm: " + score);
        location.reload();
      }
      
      sun += config.sunReward;
      score += config.scoreReward;
      sunSpan.textContent = sun;
      scoreSpan.textContent = score;
      if (z.type === "red") {
        redKills++;
        if (redKills >= 20) spawnBoss();
      }
      if (z.type === "purple") {
        alert("üèÜ B·∫°n ƒë√£ chi·∫øn th·∫Øng! T·ªïng ƒëi·ªÉm: " + score);
        location.reload();
      }
      z.el.remove();
      return false;
    }
    if (z.x <= 0) {
      alert("üíÄ Zombie ƒë√£ v√†o nh√†! Game over! T·ªïng ƒëi·ªÉm: " + score);
      location.reload();
      return false;
    }
    return true;
  });

  plants = plants.filter(p => {
    if (p.hp <= 0) {
      if (p.type === "cay11") {
        sun += 1000;
        sunSpan.textContent = sun;
      }
      p.el.remove();
      return false;
    }
    return true;
  });

  bullets = bullets.filter(b => b.x < cols && b.x > -5);
}

function fireWithMana(p, action) {
  if (p.cooldown) return;
  action(); p.lastAction = Date.now();
  p.mana = Math.min(100, p.mana + 25); p.manaFill.style.width = p.mana + "%";
  if (p.mana >= 100) { p.cooldown = true; setTimeout(() => { p.mana = 0; p.manaFill.style.width = "0%"; p.cooldown = false; }, 5000); }
}

function shoot(p, count, color, power, freeze, knock) {
  if (paused) return;
  document.getElementById("shootSound").play();
  for (let i = 0; i < count; i++) {
    const b = document.createElement("div");
    b.className = "bullet " + color;
    const pos = cellPos(p.r, p.c);
    b.style.left = (pos.x + 15 + i * 5) + "px"; 
    b.style.top = pos.y + "px";
    game.appendChild(b);
    bullets.push({ 
      r: p.r, 
      x: p.c, 
      el: b, 
      power, 
      freeze, 
      knock,
      direction: 1,
      enhanced: false,
      enhancedBy: []
    });
  }
}

setInterval(update, 50);
setTimeout(spawnThayMa2, 1000);
setTimeout(spawnThayMa3, 1000);
setTimeout(spawnThayMa4, 1000);
setTimeout(spawnThayMa5, 1000);
setTimeout(spawnThayMa6, 1000);
setTimeout(spawnZombie, 2000);
setTimeout(spawnSmartZombie, 5000);
</script>
</body>
</html>