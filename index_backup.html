<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mini PvZ - C·ªông m·∫∑t tr·ªùi v√† ƒëi·ªÉm</title>
<style>
  body { background:#9be29b; font-family:sans-serif; user-select:none; }
  h1{text-align:center;}
  #game{
    position:relative;width:980px;height:720px;margin:10px auto;
    background:repeating-linear-gradient(90deg,#7fcf7f 0,#7fcf7f 68px,#72c272 70px),
               repeating-linear-gradient(0deg,#7fcf7f 0,#7fcf7f 88px,#72c272 90px);
    border:4px solid #2a6e2a;
  }
  .plant,.zombie,.bullet{position:absolute;transform:translate(-50%,-50%);text-align:center;font-weight:bold;font-size:12px;}
  .zombie{width:60px;height:80px;background:gray;border:2px solid black;color:white;}
  .zombie.red{background:red;}
  .zombie.big{width:80px;height:100px;background:darkgray;}
  .zombie.purple{width:180px;height:180px;background:purple;font-size:18px;border:3px solid black;}
  .zombie.smart{background:url('thayma.png') center/cover no-repeat;}
  .zombie.thayma2{background:url('thayma2.png') center/cover no-repeat;}
  .zombie.thayma3{background:url('thayma3.png') center/cover no-repeat;}
  .zombie.thayma4{background:url('thayma4.png') center/cover no-repeat;}
  .zombie.thayma5{background:url('thayma5.png') center/cover no-repeat;}
  .zombie.thayma6{background:url('thayma6.png') center/cover no-repeat; width:100px;height:120px;z-index:1000;}
  /* TH√äM: CSS cho th√¢y ma 7 - S·ª© gi·∫£ khe n·ª©t */
  .zombie.thayma7 {
    background: url('thayma7.png') center/cover no-repeat;
    width: 70px;
    height: 90px;
    border: 3px solid #ff0000;
  }
  /* TH√äM: CSS cho th√¢y ma 8 - Baron Nashor */
  .zombie.thayma8 {
    background: url('thayma8.png') center/cover no-repeat;
    width: 100px;
    height: 120px;
    border: 3px solid #8B0000;
    z-index: 1001;
  }
  .bullet{width:10px;height:10px;background:yellow;border-radius:50%;}
  .bullet.green{background:lime;}
  .bullet.blue{background:cyan;}
  .bullet.az{background:orange;}
  .bullet.purple-bullet{background:purple;width:15px;height:15px;}
  /* ƒê·∫°n to m√†u ƒë·ªè c·ªßa boss */
  .bullet.red-boss-bullet{
    background:red;
    width:40px;
    height:40px;
    border-radius:0%;
    border:3px solid darkred;
    z-index: 900;
  }
  /* ƒê·∫°n ƒë∆∞·ª£c tƒÉng c∆∞·ªùng b·ªüi cay12 */
  .bullet.enhanced{
    border:2px solid gold;
    transition: all 0.1s;
  }
  /* ƒê·∫°n c·ªßa ƒë·∫°i b√°c ƒë·ªãa ng·ª•c */
  .bullet.hell-cannon{
    background:purple;
    width:20px;
    height:20px;
    border:2px solid black;
  }
  /* ƒê·∫°n c·ªßa t·ªèi bi·∫øn d·ªã */
  .bullet.garlic-bullet{
    background: #ff66b2;
    width: 12px;
    height: 12px;
    border: 1px solid #cc0066;
    box-shadow: 0 0 5px #ff3399;
  }
  /* ƒê·∫°n c·ªßa cay18 - ƒë·∫°n n√©m */
  .bullet.cay18-bullet {
    background: url('dancay18.png') center/cover no-repeat;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    border: 2px solid #8B0000;
    box-shadow: 0 0 10px #FF4500;
    z-index: 950;
  }
  
  #panel{text-align:center;margin:10px;}
  button{margin:2px 4px;padding:5px 10px;cursor:pointer;}
  #scoreBoard{
    position:absolute;
    bottom:5px;
    right:15px;
    background:rgba(255,255,255,0.6);
    padding:5px 10px;
    border-radius:8px;
    font-weight:bold;
  }
 body { background:#9be29b; font-family:sans-serif; user-select:none; }
h1 { text-align:center; }

#panel {
  text-align:center;
  margin:5px;
}

.shop-item {
  width: 30px;
  height: 35px;
  margin: 5px;
  display: inline-block;
  text-align: center;
  cursor: pointer;
  position: relative;
}

.shop-item img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng b·ªã m√©o */
  border-radius: 5px;
}

.shop-item[title]:hover::after {
  content: attr(title);
  position: absolute;
  top: -20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 3px 6px;
  background-color: rgba(0, 0, 0, 0.7);
  color: white;
  font-size: 12px;
  border-radius: 5px;
  white-space: nowrap;
}

button {
  margin: 2px 4px;
  padding: 5px 10px;
  cursor: pointer;
}

#scoreBoard {
  position: absolute;
  bottom: 5px;
  right: 15px;
  background: rgba(255, 255, 255, 0.6);
  padding: 5px 10px;
  border-radius: 8px;
  font-weight: bold;
}

#game {
  position: relative;
  width: 1400px; /* Chi·ªÅu r·ªông game */
  height: 535px; /* Chi·ªÅu cao game */
  margin: 10px auto;
  background: none;
  border: 4px solid #2a6e2a;
}

.cell {
  width: 70px; /* K√≠ch th∆∞·ªõc √¥ */
  height: 90px; /* K√≠ch th∆∞·ªõc √¥ */
  border: 1px solid #3a923a; /* ƒê∆∞·ªùng vi·ªÅn cho c√°c √¥ */
  display: inline-block;
  box-sizing: border-box;
  position: absolute;
}

.plant, .zombie, .bullet {
  position: absolute;
  transform: translate(-50%, -50%);
  text-align: center;
  font-weight: bold;
  font-size: 12px;
}

/* C√¢y - C·∫§U H√åNH CHUNG */
.plant {
  width: var(--plant-width, 60px);
  height: var(--plant-height, 60px);
  margin: 0;
  position: absolute;
}

/* Thanh mana */
.mana-bar {
  position: absolute;
  bottom: -8px;
  left: 0;
  width: var(--plant-width, 60px);
  height: 5px;
  background: rgba(255, 255, 255, 0.3);
}

.mana-fill {
  height: 100%;
  width: 0%;  /* M·ªü r·ªông thanh mana */
  background: blue;
}
/* S·ªë m√°u */
.hp-text {
  position: absolute;
  top: -15px;  /* Gi·∫£m kho·∫£ng c√°ch ƒë·ªÉ s·ªë m√°u g·∫ßn ƒë·∫ßu c√¢y h∆°n */
  left: 50%;   /* CƒÉn gi·ªØa theo chi·ªÅu ngang */
  transform: translateX(-50%); /* CƒÉn gi·ªØa ho√†n h·∫£o */
  font-size: 14px;
  color: #ff0000;  /* M√†u ƒë·ªè cho s·ªë m√°u */
}
/* Th√™m v√†o ph·∫ßn CSS cho bullet */
.bullet.red { background: red; }

/* Hi·ªáu ·ª©ng cho c√¢y cay14 khi k√≠ch ho·∫°t */
.plant.cay14 {
  transition: box-shadow 0.3s ease;
  border: 2px solid gold;
}

/* Hi·ªáu ·ª©ng cho c√¢y cay16 khi b·ªã t·∫•n c√¥ng */
.plant.cay16.hit {
  animation: mineFlash 0.5s;
  box-shadow: 0 0 20px red;
}

@keyframes mineFlash {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.5); }
}

/* Hi·ªáu ·ª©ng cho c√¢y cay17 khi b·ªã t·∫•n c√¥ng */
.plant.cay17.garlic-hit {
  animation: garlicFlash 0.5s;
  box-shadow: 0 0 15px purple;
}

@keyframes garlicFlash {
  0%, 100% { 
    filter: brightness(1) hue-rotate(0deg); 
    transform: translate(-50%, -50%) scale(1);
  }
  50% { 
    filter: brightness(1.3) hue-rotate(180deg); 
    transform: translate(-50%, -50%) scale(1.1);
  }
}

/* Hi·ªáu ·ª©ng cho c√¢y cay18 khi b·ªã t·∫•n c√¥ng */
.plant.cay18.hit {
  animation: cay18Flash 0.5s;
  box-shadow: 0 0 20px #FF4500;
}

@keyframes cay18Flash {
  0%, 100% { 
    filter: brightness(1) hue-rotate(0deg); 
    transform: translate(-50%, -50%) scale(1);
  }
  50% { 
    filter: brightness(1.5) hue-rotate(90deg); 
    transform: translate(-50%, -50%) scale(1.2);
  }
}

/* Hi·ªáu ·ª©ng cho zombie khi b·ªã t·ªèi t·∫•n c√¥ng */
.zombie.garlic-effect {
  border: 2px solid purple !important;
  box-shadow: 0 0 10px purple;
  animation: garlicZombie 5s linear;
}

@keyframes garlicZombie {
  0% { border-color: purple; }
  50% { border-color: #ff66ff; }
  100% { border-color: purple; }
}

/* Hi·ªáu ·ª©ng cho zombie khi b·ªã cay18 t·∫•n c√¥ng */
.zombie.cay18-slow {
  border: 2px solid #FF4500 !important;
  box-shadow: 0 0 15px #FF8C00;
  filter: brightness(0.8) sepia(1) hue-rotate(-30deg);
}

/* Hi·ªáu ·ª©ng cho zombie khi b·ªã t·∫•n c√¥ng b·ªüi cay14 */
.zombie.hit-by-cay14 {
  animation: hitFlash 0.5s;
}

@keyframes hitFlash {
  0%, 100% { filter: brightness(1); }
  50% { filter: brightness(1.5); }
}

/* Hi·ªáu ·ª©ng h·ªìi m√°u */
.heal-effect {
  position: absolute;
  width: 60px;
  height: 60px;
  background: radial-gradient(circle, rgba(0,255,0,0.5) 0%, rgba(0,255,0,0) 70%);
  border-radius: 50%;
  animation: healPulse 1s ease-out;
  pointer-events: none;
  z-index: 500;
}

@keyframes healPulse {
  0% { transform: scale(0.5); opacity: 1; }
  100% { transform: scale(2); opacity: 0; }
}

/* Hi·ªáu ·ª©ng m√¨n n·ªï */
.mine-explosion-effect {
  position: absolute;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, rgba(255,0,0,0.7) 0%, rgba(255,0,0,0) 70%);
  border-radius: 50%;
  animation: explosionPulse 0.8s ease-out;
  pointer-events: none;
  z-index: 800;
}

@keyframes explosionPulse {
  0% { transform: scale(0.1); opacity: 1; }
  100% { transform: scale(1.5); opacity: 0; }
}

/* Hi·ªáu ·ª©ng ƒë·∫°n t·ªèi */
.garlic-bullet-trail {
  position: absolute;
  width: 8px;
  height: 8px;
  background: rgba(255, 102, 178, 0.5);
  border-radius: 50%;
  pointer-events: none;
  z-index: 400;
  animation: garlicTrail 0.3s forwards;
}

@keyframes garlicTrail {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(0); opacity: 0; }
}

/* Hi·ªáu ·ª©ng ƒë·∫°n n√©m cay18 */
.cay18-throw-effect {
  position: absolute;
  width: 15px;
  height: 15px;
  background: radial-gradient(circle, rgba(255,69,0,0.7) 0%, rgba(255,69,0,0) 70%);
  border-radius: 50%;
  pointer-events: none;
  z-index: 400;
  animation: cay18Throw 0.5s forwards;
}

@keyframes cay18Throw {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(2); opacity: 0; }
}

/* Hi·ªáu ·ª©ng ƒë·∫°n n·∫£y cay18 */
.cay18-bounce-effect {
  position: absolute;
  width: 20px;
  height: 20px;
  background: radial-gradient(circle, rgba(255,140,0,0.8) 0%, rgba(255,140,0,0) 70%);
  border-radius: 50%;
  pointer-events: none;
  z-index: 400;
  animation: cay18Bounce 0.3s forwards;
}

@keyframes cay18Bounce {
  0% { transform: scale(0.5); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.8; }
  100% { transform: scale(1); opacity: 0; }
}

/* Hi·ªáu ·ª©ng buff c·ªßa Baron */
.zombie.baron-buffed {
  box-shadow: 0 0 15px #00FF00 !important;
  filter: brightness(1.3) !important;
}
</style>
</head>
<body>

<div id="timer" style="position: absolute; top: 10px; right: 20px; font-size: 20px; color: white;">00:00</div>
<div id="panel">
  ‚òÄÔ∏è M·∫∑t tr·ªùi: <span id="sun">100</span>
<div class="shop-item" id="sunflower" onclick="selectPlant('sunflower')" title="Gi√°: 50">
  <img src="cay1.png" alt="H∆∞·ªõng d∆∞∆°ng">
</div>
<div class="shop-item" id="bigsun" onclick="selectPlant('bigsun')" title="Gi√°: 500">
  <img src="cay2.png" alt="H∆∞·ªõng d∆∞∆°ng to">
</div>
<div class="shop-item" id="pea" onclick="selectPlant('pea')" title="Gi√°: 100">
  <img src="cay3.png" alt="Pea">
</div>
<div class="shop-item" id="peaice" onclick="selectPlant('peaice')" title="Gi√°: 175">
  <img src="cay4.png" alt="Pea bƒÉng">
</div>
<div class="shop-item" id="pea2" onclick="selectPlant('pea2')" title="Gi√°: 200">
  <img src="cay5.png" alt="Pea 2 ƒë·∫ßu">
</div>
<div class="shop-item" id="wallnut" onclick="selectPlant('wallnut')" title="Gi√°: 15">
  <img src="cay6.png" alt="√ìc ch√≥">
</div>
<div class="shop-item" id="cherry" onclick="selectPlant('cherry')" title="Gi√°: 250">
  <img src="cay7.png" alt="Cherry">
</div>
<div class="shop-item" id="azami" onclick="selectPlant('azami')" title="Gi√°: 1000">
  <img src="cay8.png" alt="Azami">
</div>
<div class="shop-item" id="shovel" onclick="selectPlant('shovel')" title="Gi√°: 0">
  <img src="cay9.png" alt="X·∫ªng">
</div>
<div class="shop-item" id="cay10" onclick="selectPlant('cay10')" title="Gi√°: 1500">
  <img src="cay10.png" alt="C√¢y si√™u b·∫Øn">
</div>
<!-- C√¢y ph·∫£n ƒë·∫°n -->
<div class="shop-item" id="cay11" onclick="selectPlant('cay11')" title="Gi√°: 5000 - Ph·∫£n ƒë·∫°n">
  <img src="cay11.png" alt="C√¢y ph·∫£n ƒë·∫°n">
</div>
<!-- C√¢y tƒÉng c∆∞·ªùng ƒë·∫°n -->
<div class="shop-item" id="cay12" onclick="selectPlant('cay12')" title="Gi√°: 5000 - TƒÉng c∆∞·ªùng ƒë·∫°n">
  <img src="cay12.png" alt="C√¢y tƒÉng c∆∞·ªùng ƒë·∫°n">
</div>
<!-- C√¢y m·ªõi -->
<div class="shop-item" id="cay13" onclick="selectPlant('cay13')" title="Gi√°: 10000 - H·∫Øc di·ªáp th·∫°ch">
  <img src="cay13.png" alt="H·∫Øc di·ªáp th·∫°ch">
</div>
<div class="shop-item" id="cay14" onclick="selectPlant('cay14')" title="Gi√°: 25000 - √ìc ch√≥ si√™u khuy·ªÉn (Gi·∫£m 50% s√°t th∆∞∆°ng, K·ªπ nƒÉng 3x3)">
  <img src="cay14.png" alt="√ìc ch√≥ si√™u khuy·ªÉn">
</div>
<div class="shop-item" id="cay15" onclick="selectPlant('cay15')" title="Gi√°: 20000 - ƒê·∫°i b√°c ƒë·ªãa ng·ª•c">
  <img src="cay15.png" alt="ƒê·∫°i b√°c ƒë·ªãa ng·ª•c">
</div>
<!-- C√¢y m√¨n h·∫Øc di·ªáp th·∫°ch -->
<div class="shop-item" id="cay16" onclick="selectPlant('cay16')" title="Gi√°: 1500 - M√¨n h·∫Øc di·ªáp th·∫°ch (3000 m√°u, h·ªìi 1 HP/s cho to√†n b·ªô c√¢y, khi b·ªã t·∫•n c√¥ng g√¢y 30 s√°t th∆∞∆°ng to√†n s√¢n)">
  <img src="cay16.png" alt="M√¨n h·∫Øc di·ªáp th·∫°ch">
</div>
<!-- C√¢y t·ªèi bi·∫øn d·ªã -->
<div class="shop-item" id="cay17" onclick="selectPlant('cay17')" title="Gi√°: 2000 - T·ªèi bi·∫øn d·ªã (B·∫Øn ƒë·∫°n t·∫ßm 2 √¥, 10 s√°t th∆∞∆°ng + b·∫≠t l√πi 0.5 √¥, khi b·ªã t·∫•n c√¥ng ƒë·∫©y zombie sang h√†ng kh√°c + l√†m ch·∫≠m 80% 5s)">
  <img src="cay17.png" alt="T·ªèi bi·∫øn d·ªã">
</div>
<!-- C√¢y t·ªèi bi·∫øn d·ªã phi√™n b·∫£n n√©m ƒë·∫°n -->
<div class="shop-item" id="cay18" onclick="selectPlant('cay18')" title="Gi√°: 50000 - T·ªèi bi·∫øn d·ªã n√©m ƒë·∫°n (30 m√°u, n√©m ƒë·∫°n n·∫£y, 30 s√°t th∆∞∆°ng + 3 ƒë·∫°n n·∫£y 20 s√°t th∆∞∆°ng, gi·∫£m t·ªëc 30% vƒ©nh vi·ªÖn, khi b·ªã t·∫•n c√¥ng ƒë·∫©y zombie + gi·∫£m 99% t·ªëc 10s)">
  <img src="cay18.png" alt="T·ªèi bi·∫øn d·ªã n√©m ƒë·∫°n">
</div>
  <div class="shop-item" id="noSelect" onclick="deselectPlant()" title="Kh√¥ng ch·ªçn c√¢y">
  <img src="no_select_icon.png" alt="Kh√¥ng ch·ªçn c√¢y">
  </div>
  <button id="pauseBtn" onclick="togglePause()">‚è∏Ô∏è T·∫°m d·ª´ng</button>
  <span id="selected"></span>
</div>


<div id="game">
  <div id="scoreBoard">üèÜ ƒêi·ªÉm: <span id="score">0</span></div>
</div>

<audio id="shootSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="boomSound" src="https://actions.google.com/sounds/v1/explosions/explosion.ogg"></audio>
<audio id="dieSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
<audio id="garlicSound" src="https://actions.google.com/sounds/v1/cartoon/slide_whistle.ogg"></audio>
<audio id="throwSound" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"></audio>
<audio id="bounceSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_bounce.ogg"></audio>

<script>
// =============== C·∫§U H√åNH D·ªÑ CH·ªàNH S·ª¨A ===============
const PLANT_CONFIG = {
  defaultSize: {
    width: 60,
    height: 60
  },
  
  plants: {
    sunflower: {
      name: "H∆∞·ªõng d∆∞∆°ng",
      cost: 50,
      hp: 20,
      image: "cay1.png",
      width: 60,
      height: 60,
      action: {
        type: "sunProducer",
        interval: 5000,
        amount: 25
      }
    },
    bigsun: {
      name: "H∆∞·ªõng d∆∞∆°ng to",
      cost: 500,
      hp: 25,
      image: "cay2.png",
      width: 65,
      height: 65,
      action: {
        type: "sunProducer",
        interval: 1000,
        amount: 10
      }
    },
    pea: {
      name: "Pea",
      cost: 100,
      hp: 15,
      image: "cay3.png",
      width: 60,
      height: 60,
      action: {
        type: "shooter",
        interval: 1500,
        bullet: { color: "yellow", power: 2, count: 1 }
      }
    },
    peaice: {
      name: "Pea bƒÉng",
      cost: 175,
      hp: 15,
      image: "cay4.png",
      width: 60,
      height: 60,
      action: {
        type: "shooter",
        interval: 2000,
        bullet: { color: "blue", power: 1, count: 1, freeze: true }
      }
    },
    pea2: {
      name: "Pea 2 ƒë·∫ßu",
      cost: 200,
      hp: 15,
      image: "cay5.png",
      width: 65,
      height: 60,
      action: {
        type: "shooter",
        interval: 2000,
        bullet: { color: "green", power: 2, count: 2 }
      }
    },
    wallnut: {
      name: "√ìc ch√≥",
      cost: 15,
      hp: 500,
      image: "cay6.png",
      width: 70,
      height: 70,
      action: { type: "none" }
    },
    cherry: {
      name: "Cherry",
      cost: 250,
      hp: 10,
      image: "cay7.png",
      width: 60,
      height: 60,
      action: {
        type: "exploder",
        delay: 1500,
        damage: 1000,
        range: 1.5
      }
    },
    azami: {
      name: "Azami",
      cost: 1000,
      hp: 50,
      image: "cay8.png",
      width: 60,
      height: 60,
      action: {
        type: "shooter",
        interval: 700,
        bullet: { color: "az", power: 10, count: 1, knock: true },
        cost: 25
      },
      limitPerRow: 1
    },
    cay10: {
      name: "C√¢y si√™u b·∫Øn",
      cost: 1500,
      hp: 90,
      image: "cay10.png",
      width: 90,
      height: 70,
      action: {
        type: "shooter",
        interval: 4000,
        bullet: { color: "red", power: 30, count: 1 }
      },
      limitPerRow: 1
    },
    shovel: {
      name: "X·∫ªng",
      cost: 0,
      hp: 0,
      image: "cay9.png",
      width: 50,
      height: 50,
      action: { type: "tool" }
    },
    cay11: {
      name: "C√¢y ph·∫£n ƒë·∫°n",
      cost: 5000,
      hp: 10,
      maxHp: 10,
      image: "cay11.png",
      width: 60,
      height: 60,
      action: { type: "reflector" }
    },
    cay12: {
      name: "C√¢y tƒÉng c∆∞·ªùng ƒë·∫°n",
      cost: 5000,
      hp: 50,
      image: "cay12.png",
      width: 60,
      height: 60,
      action: { type: "enhancer" }
    },
    cay13: {
      name: "H·∫Øc di·ªáp th·∫°ch",
      cost: 10000,
      hp: 1700,
      maxHp: 1700,
      image: "cay13.png",
      width: 70,
      height: 70,
      action: { 
        type: "blocker",
        healPerSecond: 30
      }
    },
    cay14: {
      name: "√ìc ch√≥ si√™u khuy·ªÉn",
      cost: 25000,
      hp: 8000,
      maxHp: 8000,
      image: "cay14.png",
      width: 80,
      height: 80,
      action: {
        type: "areaHealer",
        interval: 3000,
        damage: 100,
        range: 1,
        healMultiplier: 1.0,
        damageReduction: 0.5
      }
    },
    cay15: {
      name: "ƒê·∫°i b√°c ƒë·ªãa ng·ª•c",
      cost: 20000,
      hp: 600,
      image: "cay15.png",
      width: 70,
      height: 70,
      action: {
        type: "hellCannon",
        interval: 800,
        bullet: { color: "hell-cannon", power: 10, count: 1, knock: true }
      }
    },
    cay16: {
      name: "M√¨n h·∫Øc di·ªáp th·∫°ch",
      cost: 1500,
      hp: 3000,
      maxHp: 3000,
      image: "cay16.png",
      width: 60,
      height: 60,
      action: {
        type: "mine",
        healPerSecond: 1,
        explosionDamage: 30,
        explosionOnHit: true
      }
    },
    cay17: {
      name: "T·ªèi bi·∫øn d·ªã",
      cost: 2000,
      hp: 80,
      image: "cay17.png",
      width: 60,
      height: 60,
      action: {
        type: "garlic",
        interval: 2000,
        bullet: { 
          color: "garlic-bullet", 
          power: 10, 
          count: 1, 
          knock: true,
          knockDistance: 0.5,
          range: 2
        },
        defenseEffect: {
          teleportDistance: 1,
          slowAmount: 0.8,
          slowDuration: 5000
        }
      }
    },
    cay18: {
      name: "T·ªèi bi·∫øn d·ªã n√©m ƒë·∫°n",
      cost: 50000,
      hp: 80,
      maxHp: 80,
      image: "cay18.png",
      width: 65,
      height: 65,
      action: {
        type: "thrower",
        interval: 3000,
        bullet: {
          image: "dancay18.png",
          mainDamage: 80,
          bounceDamage: 20,
          bounceCount: 3,
          slowAmount: 0.3,
          maxSlow: 1.0,
          throwHeight: 60
        },
        defenseEffect: {
          teleportDistance: 1,
          extremeSlowAmount: 0.99,
          extremeSlowDuration: 10000
        }
      }
    }
  }
};

// =============== C·∫§U H√åNH TH√ÇY MA D·ªÑ CH·ªàNH S·ª¨A ===============
const ZOMBIE_CONFIG = {
  attackInterval: 1000,
  
  zombies: {
    normal: {
      name: "Th√¢y ma th∆∞·ªùng",
      baseHp: 44,
      speed: 0.01,
      attackDamage: 2,
      sunReward: 25,
      scoreReward: 1
    },
    red: {
      name: "Th√¢y ma ƒë·ªè",
      baseHp: 62,
      speed: 0.007,
      attackDamage: 3,
      hpBonusPerKill: 5,
      sunReward: 25,
      scoreReward: 1
    },
    big: {
      name: "Th√¢y ma to",
      baseHp: 90,
      speed: 0.0025,
      attackDamage: 5,
      sunReward: 25,
      scoreReward: 1
    },
    smart: {
      name: "Th√¢y ma th√¥ng minh",
      baseHp: 90,
      speed: 0.013,
      attackDamage: 3,
      sunReward: 25,
      scoreReward: 1
    },
    purple: {
      name: "Boss",
      baseHp: 500,
      speed: 0.001,
      attackDamage: 10,
      sunReward: 25,
      scoreReward: 1
    },
    thayma2: {
      name: "Th√¢y ma 2 - ƒêi xuy√™n qua c√¢y",
      baseHp: 100,
      speed: 0.015,
      attackDamage: 0,
      canAttack: false,
      passThroughPlants: true,
      sunReward: 50,
      scoreReward: 3
    },
    thayma3: {
      name: "Th√¢y ma 3 - Ch·∫∑n ƒë∆∞·ªùng",
      baseHp: 3000,
      speed: 0.02,
      attackDamage: 0,
      canAttack: false,
      stopsAtPlant: true,
      sunReward: 75,
      scoreReward: 5
    },
    thayma4: {
      name: "Th√¢y ma 4 - Bom n·ªï",
      baseHp: 500,
      speed: 0.0015,
      attackDamage: 999,
      explosionOnDeath: true,
      explosionRange: 1.5,
      sunReward: 100,
      scoreReward: 10
    },
    thayma5: {
      name: "Th√¢y ma 5 - Chi·∫øn binh b·∫•t kh·∫£ chi·∫øn b·∫°i",
      baseHp: 8000,
      speed: 0.018,
      attackDamage: 5,
      immuneToControl: true,
      immuneToKnockback: true,
      canAttack: true,
      sunReward: 150,
      scoreReward: 15
    },
    thayma6: {
      name: "Th√¢y ma 6 - Qu√°i v·∫≠t t·ªëi th∆∞·ª£ng",
      baseHp: 5000000,
      speed: 0.01,
      attackDamage: 0,
      canAttack: false,
      immuneToControl: true,
      immuneToKnockback: true,
      immuneToExplosion: true,
      stopsAtDistance: 2,
      rangedAttack: true,
      rangedDamage: 200,
      rangedInterval: 5000,
      rangedTarget: "first",
      sunReward: 1000,
      scoreReward: 100,
      winOnKill: true
    },
    // TH√ÇY MA 7 - S·ª® GI·∫¢ KHE N·ª®T
    thayma7: {
      name: "S·ª© gi·∫£ khe n·ª©t",
      baseHp: 10000,
      speed: 0.015,
      attackDamage: 999,
      attackInterval: 3000,
      canAttack: true,
      knockbackOnHit: true,
      knockbackDistance: 1,
      sunReward: 500,
      scoreReward: 50
    },
    // TH√ÇY MA 8 - BARON NASHOR
    thayma8: {
      name: "Baron Nashor",
      baseHp: 100000,
      speed: 0.02,
      attackDamage: 0,
      canAttack: false,
      stopsAtDistance: 2,
      immuneToControl: true,
      immuneToKnockback: true,
      immuneToExplosion: true,
      buffsThayma7: true,
      buffSpeedAmount: 1.0,
      buffAttackSpeedAmount: 1.0,
      spawnsThayma7OnDeath: true,
      spawnedThayma7Hp: 300000,
      spawnOnAppearance: true,
      sunReward: 1000,
      scoreReward: 200
    }
  },
  
  timeUpdates: {
    interval: 30,
    hpIncrease: 10,
    speedIncrease: 0.01
  }
};

const rows = 8;
const cols = 20;
const game = document.getElementById("game");
const sunSpan = document.getElementById("sun");
const scoreSpan = document.getElementById("score");
let sun = 100, score = 0;
let selectedPlant = null;
let plants = [], zombies = [], bullets = [];
let zombieSpawnRate = 3000, zombieCount = 0, redKills = 0, bossSpawned = false;
let paused = false;
let startTime = Date.now();
let lastUpdateTime = 0;
let elapsedTime = 0;

// Bi·∫øn ƒëi·ªÅu khi·ªÉn spawn c√°c lo·∫°i th√¢y ma ƒë·∫∑c bi·ªát
let thayma2Spawned = false;
let thayma3Spawned = false;
let thayma4Spawned = false;
let thayma5Spawned = false;
let thayma6Spawned = false;
let thayma7Spawned = false;
let thayma8Spawned = false;
let thayma8Count = 0;
let thayma7Buffed = false;

// Th·ªùi gian spawn c√°c th√¢y ma ƒë·∫∑c bi·ªát
const THAYMA2_SPAWN_TIME = 45;
const THAYMA3_SPAWN_TIME = 60;
const THAYMA4_SPAWN_TIME = 90;
const THAYMA5_SPAWN_TIME = 120;
const THAYMA6_SPAWN_TIME = 60;
const THAYMA7_SPAWN_TIME = 600; // 10 ph√∫t
const THAYMA8_FIRST_SPAWN_TIME = 180; // 3 ph√∫t
const THAYMA8_SECOND_SPAWN_TIME = 600; // 10 ph√∫t

// =============== C√ÅC H√ÄM H·ªñ TR·ª¢ ===============
function createGarlicTrail(x, y) {
  const trail = document.createElement("div");
  trail.className = "garlic-bullet-trail";
  trail.style.left = x + "px";
  trail.style.top = y + "px";
  game.appendChild(trail);
  
  setTimeout(() => {
    if (trail.parentNode) {
      trail.parentNode.removeChild(trail);
    }
  }, 300);
}

function createThrowEffect(x, y) {
  const effect = document.createElement("div");
  effect.className = "cay18-throw-effect";
  effect.style.left = x + "px";
  effect.style.top = y + "px";
  game.appendChild(effect);
  
  setTimeout(() => {
    if (effect.parentNode) {
      effect.parentNode.removeChild(effect);
    }
  }, 500);
}

function createBounceEffect(x, y) {
  const effect = document.createElement("div");
  effect.className = "cay18-bounce-effect";
  effect.style.left = x + "px";
  effect.style.top = y + "px";
  game.appendChild(effect);
  
  setTimeout(() => {
    if (effect.parentNode) {
      effect.parentNode.removeChild(effect);
    }
  }, 300);
}

function applyPermanentSlow(zombie, slowAmount, maxSlow) {
  if (zombie.immuneToControl) return;
  
  if (!zombie.totalSlowAmount) {
    zombie.totalSlowAmount = 0;
  }
  
  const newSlowAmount = Math.min(maxSlow, zombie.totalSlowAmount + slowAmount);
  const additionalSlow = newSlowAmount - zombie.totalSlowAmount;
  
  if (additionalSlow > 0) {
    zombie.totalSlowAmount = newSlowAmount;
    zombie.slow = 1 - zombie.totalSlowAmount;
    zombie.el.classList.add("cay18-slow");
    const brightness = 1 - (zombie.totalSlowAmount * 0.5);
    zombie.el.style.filter = `brightness(${brightness}) sepia(1) hue-rotate(-${zombie.totalSlowAmount * 30}deg)`;
  }
}

function applyExtremeSlow(zombie, slowAmount, duration) {
  if (zombie.immuneToControl) return;
  
  if (!zombie.originalSpeed) {
    zombie.originalSpeed = zombie.speed;
  }
  
  zombie.slow = 1 - slowAmount;
  zombie.el.style.boxShadow = "0 0 20px #FF0000";
  zombie.el.style.filter = "brightness(0.5) blur(1px)";
  
  const possibleRows = [];
  if (zombie.r > 0) possibleRows.push(zombie.r - 1);
  if (zombie.r < rows - 1) possibleRows.push(zombie.r + 1);
  
  if (possibleRows.length > 0) {
    const newRow = possibleRows[Math.floor(Math.random() * possibleRows.length)];
    zombie.r = newRow;
    const pos = cellPos(zombie.r, zombie.x);
    zombie.el.style.top = pos.y + "px";
  }
  
  setTimeout(() => {
    if (zombie.el && zombie.el.parentNode) {
      zombie.el.style.boxShadow = "";
      zombie.el.style.filter = "";
      if (zombie.originalSpeed) {
        if (zombie.totalSlowAmount) {
          zombie.slow = 1 - zombie.totalSlowAmount;
        } else {
          zombie.slow = 1;
        }
      }
    }
  }, duration);
}

function findNearestZombies(targetZombie, excludeZombie, count = 3) {
  const distances = [];
  zombies.forEach(z => {
    if (z !== targetZombie && z !== excludeZombie) {
      const distance = Math.sqrt(
        Math.pow(z.r - targetZombie.r, 2) + 
        Math.pow(z.x - targetZombie.x, 2)
      );
      distances.push({ zombie: z, distance });
    }
  });
  distances.sort((a, b) => a.distance - b.distance);
  return distances.slice(0, count).map(item => item.zombie);
}

function createBounceBullet(startX, startY, targetZombie, damage, plant) {
  const bullet = document.createElement("div");
  bullet.className = "bullet cay18-bullet";
  bullet.style.left = startX + "px";
  bullet.style.top = startY + "px";
  bullet.style.zIndex = "960";
  game.appendChild(bullet);
  
  const nextTargets = findNearestZombies(targetZombie, targetZombie, 1);
  let nextTarget = nextTargets[0];
  let targetX = startX;
  let targetY = startY;
  let hasTarget = false;
  
  if (nextTarget) {
    const targetPos = cellPos(nextTarget.r, nextTarget.x);
    targetX = targetPos.x;
    targetY = targetPos.y;
    hasTarget = true;
  } else {
    targetX = startX + 100;
    targetY = startY;
  }
  
  const startTime = Date.now();
  const duration = hasTarget ? 800 : 500;
  const controlY = Math.min(startY, targetY) - 40;
  
  const bulletObj = {
    el: bullet,
    startX: startX,
    startY: startY,
    targetX: targetX,
    targetY: targetY,
    controlY: controlY,
    startTime: startTime,
    duration: duration,
    damage: damage,
    target: nextTarget,
    plant: plant,
    isBounce: true,
    hasHit: false,
    isProcessed: false
  };
  
  bullets.push(bulletObj);
  createBounceEffect(startX, startY);
  document.getElementById("bounceSound").play();
  return bulletObj;
}

function selectPlant(t) {
  selectedPlant = t;
  document.getElementById("selected").textContent = "‚Üí " + t;
}

function cellPos(r, c) {
  return {
    x: c * 70 + 35,
    y: r * 90 + 45
  };
}

function togglePause() {
  paused = !paused;
  document.getElementById("pauseBtn").textContent = paused ? "‚ñ∂Ô∏è Ti·∫øp t·ª•c" : "‚è∏Ô∏è T·∫°m d·ª´ng";
}

// =============== X·ª¨ L√ù CLICK TR·ªíNG C√ÇY ===============
game.onclick = (e) => {
  if (!selectedPlant || paused) return;
  const rect = game.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  const c = Math.floor(x / 70), r = Math.floor(y / 90);

  const exist = plants.find(p => p.r === r && p.c === c);
  if (selectedPlant === 'shovel') {
    if (exist) {
      exist.el.remove();
      plants = plants.filter(p => p !== exist);
      const config = PLANT_CONFIG.plants[exist.type];
      sun += Math.floor(config.cost * 0.5);
      sunSpan.textContent = sun;
    }
    return;
  }

  if (exist) return;
  
  const config = PLANT_CONFIG.plants[selectedPlant];
  if (!config || sun < config.cost) return;
  
  if (selectedPlant === 'azami' || selectedPlant === 'cay10') {
    const plantsInRow = plants.filter(p => p.r === r && p.type === selectedPlant);
    if (plantsInRow.length >= (config.limitPerRow || 1)) {
      alert(`M·ªói h√†ng ch·ªâ ƒë∆∞·ª£c tr·ªìng t·ªëi ƒëa ${config.limitPerRow} c√¢y ${config.name}!`);
      return;
    }
  }
  
  sun -= config.cost;
  sunSpan.textContent = sun;
  addPlant(r, c, selectedPlant);
}

function deselectPlant() {
  selectedPlant = null;
  document.getElementById("selected").textContent = "‚Üí Kh√¥ng ch·ªçn c√¢y";
}

// =============== H√ÄM TH√äM C√ÇY ===============
function addPlant(r, c, type) {
  const config = PLANT_CONFIG.plants[type];
  if (!config) return;

  const el = document.createElement("div");
  el.className = "plant " + type;
  const pos = cellPos(r, c);
  el.style.left = pos.x + "px";
  el.style.top = pos.y + "px";
  
  el.style.setProperty('--plant-width', config.width + 'px');
  el.style.setProperty('--plant-height', config.height + 'px');
  el.style.width = config.width + 'px';
  el.style.height = config.height + 'px';

  const plantImage = document.createElement("img");
  plantImage.src = config.image;
  plantImage.alt = config.name;
  plantImage.style.width = "100%";
  plantImage.style.height = "100%";
  el.appendChild(plantImage);

  const hpT = document.createElement("div");
  hpT.className = "hp-text";
  hpT.textContent = config.hp;
  el.appendChild(hpT);

  const manaBar = document.createElement("div");
  manaBar.className = "mana-bar";
  const manaFill = document.createElement("div");
  manaFill.className = "mana-fill";
  manaBar.appendChild(manaFill);
  el.appendChild(manaBar);

  game.appendChild(el);

  const p = {
    r,
    c,
    type,
    hp: config.hp,
    maxHp: config.hp,
    el,
    hpT,
    mana: 0,
    manaFill,
    config: config,
    lastAction: Date.now(),
    lastHealTime: Date.now(),
    lastHitTime: 0,
    cooldown: false,
    reflectionCount: 0,
    lastSkillTime: Date.now(),
    lastAttackTime: 0
  };

  plants.push(p);

  setInterval(() => {
    if (p.type === "sunflower" || p.type === "bigsun") {
      if (p.mana < 100) {
        p.mana += 25;
        p.manaFill.style.width = Math.min(100, p.mana) + "%";
      } else {
        sun += 50;
        sunSpan.textContent = sun;
        p.mana = 0;
        p.manaFill.style.width = "0%";
      }
    }
  }, 1000);

  if (type === "cherry") setTimeout(() => explode(p), 1500);
}

function explode(p) {
  if (paused) return;
  document.getElementById("boomSound").play();
  
  const config = p.config.action;
  const damage = config.damage || 999;
  const range = config.range || 1.5;
  
  zombies.forEach(z => {
    if (z.type === "thayma6" && z.config.immuneToExplosion) return;
    if (z.type === "thayma8" && z.config.immuneToExplosion) return;
    
    if (Math.abs(z.r - p.r) <= range && Math.abs(z.x - p.c) < range) {
      z.hp -= damage;
    }
  });
  
  p.el.remove();
  plants = plants.filter(x => x !== p);
}

// =============== HI·ªÜU ·ª®NG ===============
function createHealEffect(x, y) {
  const healEl = document.createElement("div");
  healEl.className = "heal-effect";
  healEl.style.left = x + "px";
  healEl.style.top = y + "px";
  game.appendChild(healEl);
  
  setTimeout(() => {
    if (healEl.parentNode) {
      healEl.parentNode.removeChild(healEl);
    }
  }, 1000);
}

function createMineExplosionEffect(x, y) {
  const explosionEl = document.createElement("div");
  explosionEl.className = "mine-explosion-effect";
  explosionEl.style.left = x + "px";
  explosionEl.style.top = y + "px";
  game.appendChild(explosionEl);
  
  setTimeout(() => {
    if (explosionEl.parentNode) {
      explosionEl.parentNode.removeChild(explosionEl);
    }
  }, 800);
}

function applyGarlicEffect(zombie, plant) {
  if (zombie.immuneToControl) return;
  
  const config = plant.config.action.defenseEffect;
  if (!zombie.originalSpeed) {
    zombie.originalSpeed = zombie.speed;
  }
  zombie.slow = 0.2;
  zombie.el.classList.add("garlic-effect");
  
  const possibleRows = [];
  if (zombie.r > 0) possibleRows.push(zombie.r - 1);
  if (zombie.r < rows - 1) possibleRows.push(zombie.r + 1);
  
  if (possibleRows.length > 0) {
    const newRow = possibleRows[Math.floor(Math.random() * possibleRows.length)];
    zombie.r = newRow;
    const pos = cellPos(zombie.r, zombie.x);
    zombie.el.style.top = pos.y + "px";
  }
  
  setTimeout(() => {
    if (zombie.el && zombie.el.parentNode) {
      zombie.el.classList.remove("garlic-effect");
      if (zombie.originalSpeed) {
        zombie.slow = 1;
      }
    }
  }, config.slowDuration);
}

// =============== SPAWN ZOMBIE TH∆Ø·ªúNG ===============
function spawnZombie() {
  if (paused) {
    setTimeout(spawnZombie, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  const r = Math.floor(Math.random() * 5);
  
  let type = "normal";
  if (elapsed > 30 && Math.random() < 0.15) type = "red";
  if (elapsed > 60 && Math.random() < 0.05) type = "big";

  const z = document.createElement("div");
  z.className = "zombie " + (type === "red" ? "red" : type === "big" ? "big" : "");
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies[type];
  let hp = config.baseHp;
  if (type === "red") hp += 5 * Math.min(zombieCount, 10);
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type, 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack || true,
    config: config,
    immuneToControl: config.immuneToControl || false,
    immuneToKnockback: config.immuneToKnockback || false,
    immuneToExplosion: config.immuneToExplosion || false,
    passThroughPlants: config.passThroughPlants || false
  };
  
  zombies.push(zombie);
  zombieCount++;
  setTimeout(spawnZombie, 3000);
}

// =============== SPAWN TH√ÇY MA 2 ===============
function spawnThayMa2() {
  if (paused || thayma2Spawned) {
    setTimeout(spawnThayMa2, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA2_SPAWN_TIME) {
    setTimeout(spawnThayMa2, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma2";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma2;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma2", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    passThroughPlants: config.passThroughPlants,
    config: config
  };

  zombies.push(zombie);
  thayma2Spawned = true;
  
  setTimeout(() => {
    thayma2Spawned = false;
    setTimeout(spawnThayMa2, 30000);
  }, 30000);
}

// =============== SPAWN TH√ÇY MA 3 ===============
function spawnThayMa3() {
  if (paused || thayma3Spawned) {
    setTimeout(spawnThayMa3, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA3_SPAWN_TIME) {
    setTimeout(spawnThayMa3, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma3";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma3;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma3", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    stopsAtPlant: config.stopsAtPlant,
    stopped: false,
    stuck: false,
    config: config
  };

  zombies.push(zombie);
  thayma3Spawned = true;
  
  setTimeout(() => {
    thayma3Spawned = false;
    setTimeout(spawnThayMa3, 45000);
  }, 45000);
}

// =============== SPAWN TH√ÇY MA 4 ===============
function spawnThayMa4() {
  if (paused || thayma4Spawned) {
    setTimeout(spawnThayMa4, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA4_SPAWN_TIME) {
    setTimeout(spawnThayMa4, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma4";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma4;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma4", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: true,
    explosionOnDeath: config.explosionOnDeath,
    explosionRange: config.explosionRange,
    config: config
  };

  zombies.push(zombie);
  thayma4Spawned = true;
  
  setTimeout(() => {
    thayma4Spawned = false;
    setTimeout(spawnThayMa4, 60000);
  }, 60000);
}

// =============== SPAWN TH√ÇY MA 5 ===============
function spawnThayMa5() {
  if (paused || thayma5Spawned) {
    setTimeout(spawnThayMa5, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA5_SPAWN_TIME) {
    setTimeout(spawnThayMa5, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma5";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma5;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma5", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    immuneToControl: config.immuneToControl,
    immuneToKnockback: config.immuneToKnockback,
    config: config
  };

  zombies.push(zombie);
  thayma5Spawned = true;
  
  setTimeout(() => {
    thayma5Spawned = false;
    setTimeout(spawnThayMa5, 60000);
  }, 60000);
}

// =============== SPAWN TH√ÇY MA 6 ===============
function spawnThayMa6() {
  if (paused || thayma6Spawned) {
    setTimeout(spawnThayMa6, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA6_SPAWN_TIME) {
    setTimeout(spawnThayMa6, 1000);
    return;
  }
  
  const r = 3;
  const z = document.createElement("div");
  z.className = "zombie thayma6";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma6;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-25px";
  hpT.style.fontSize = "16px";
  hpT.style.color = "gold";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma6", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    lastRangedAttack: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    immuneToControl: config.immuneToControl,
    immuneToKnockback: config.immuneToKnockback,
    immuneToExplosion: config.immuneToExplosion,
    stopsAtDistance: config.stopsAtDistance,
    hasStopped: false,
    rangedAttack: config.rangedAttack,
    rangedDamage: config.rangedDamage,
    rangedInterval: config.rangedInterval,
    rangedTarget: config.rangedTarget,
    winOnKill: config.winOnKill,
    config: config
  };

  zombies.push(zombie);
  thayma6Spawned = true;
}

// =============== SPAWN TH√ÇY MA 7 - S·ª® GI·∫¢ KHE N·ª®T ===============
function spawnThayMa7() {
  if (paused || thayma7Spawned) {
    setTimeout(spawnThayMa7, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  if (elapsed < THAYMA7_SPAWN_TIME) {
    setTimeout(spawnThayMa7, 1000);
    return;
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma7";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma7;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.style.fontSize = "14px";
  hpT.style.color = "#ff0000";
  hpT.style.fontWeight = "bold";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma7", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    knockbackOnHit: config.knockbackOnHit,
    knockbackDistance: config.knockbackDistance,
    attackInterval: config.attackInterval || 1000,
    config: config
  };

  zombies.push(zombie);
  thayma7Spawned = true;
  
  setTimeout(() => {
    thayma7Spawned = false;
    setTimeout(spawnThayMa7, 60000);
  }, 60000);
}

// =============== SPAWN TH√ÇY MA 8 - BARON NASHOR ===============
function spawnThayMa8() {
  if (paused) {
    setTimeout(spawnThayMa8, 1000);
    return;
  }
  
  const elapsed = (Date.now() - startTime) / 1000;
  
  if (elapsed < THAYMA8_FIRST_SPAWN_TIME) {
    setTimeout(spawnThayMa8, 1000);
    return;
  }
  
  if (elapsed >= THAYMA8_FIRST_SPAWN_TIME && elapsed < THAYMA8_SECOND_SPAWN_TIME) {
    if (thayma8Count >= 1) {
      setTimeout(spawnThayMa8, 1000);
      return;
    }
  } else if (elapsed >= THAYMA8_SECOND_SPAWN_TIME) {
    if (thayma8Count >= 2) {
      setTimeout(spawnThayMa8, 1000);
      return;
    }
  }
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma8";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma8;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-25px";
  hpT.style.fontSize = "16px";
  hpT.style.color = "#8B0000";
  hpT.style.fontWeight = "bold";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma8", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    stopsAtDistance: config.stopsAtDistance,
    hasStopped: false,
    immuneToControl: config.immuneToControl,
    immuneToKnockback: config.immuneToKnockback,
    immuneToExplosion: config.immuneToExplosion,
    buffsThayma7: config.buffsThayma7,
    buffSpeedAmount: config.buffSpeedAmount,
    buffAttackSpeedAmount: config.buffAttackSpeedAmount,
    spawnsThayma7OnDeath: config.spawnsThayma7OnDeath,
    spawnedThayma7Hp: config.spawnedThayma7Hp,
    spawnOnAppearance: config.spawnOnAppearance,
    config: config,
    id: "baron_" + Date.now()
  };

  zombies.push(zombie);
  thayma8Spawned = true;
  thayma8Count++;
  
  console.log("‚ö†Ô∏è BARON NASHOR ƒê√É XU·∫§T HI·ªÜN! ‚ö†Ô∏è");
  
  if (zombie.spawnOnAppearance) {
    setTimeout(() => {
      spawnThayma7ForBaron();
    }, 1000);
  }
  
  setTimeout(() => {
    spawnThayMa8();
  }, 30000);
}

function spawnThayma7ForBaron() {
  if (paused) return;
  
  const r = Math.floor(Math.random() * 5);
  const z = document.createElement("div");
  z.className = "zombie thayma7";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";

  const config = ZOMBIE_CONFIG.zombies.thayma7;
  const hp = 5000;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.style.fontSize = "14px";
  hpT.style.color = "#ff0000";
  hpT.style.fontWeight = "bold";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);

  const zombie = {
    r, 
    x: cols, 
    hp, 
    type: "thayma7", 
    speed: config.speed,
    el: z, 
    hpT, 
    attack: null, 
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: config.canAttack,
    knockbackOnHit: config.knockbackOnHit,
    knockbackDistance: config.knockbackDistance,
    attackInterval: config.attackInterval || 1000,
    config: config,
    isBaronSpawn: true
  };

  zombies.push(zombie);
  
  z.style.boxShadow = "0 0 20px purple";
  setTimeout(() => {
    if (z.el) z.el.style.boxShadow = "";
  }, 1000);
}

function spawnSuperThayma7OnBaronDeath(baron) {
  if (paused) return;
  
  console.log("üíÄ BARON NASHOR ƒê√É CH·∫æT! Tri·ªáu h·ªìi S·ª® GI·∫¢ KHE N·ª®T SI√äU C·∫§P! üíÄ");
  
  for (let r = 0; r < 5; r++) {
    setTimeout(() => {
      const z = document.createElement("div");
      z.className = "zombie thayma7";
      const pos = cellPos(r, cols);
      z.style.left = pos.x + "px";
      z.style.top = pos.y + "px";

      const config = ZOMBIE_CONFIG.zombies.thayma7;
      const hp = baron.spawnedThayma7Hp || 300000;
      
      const hpT = document.createElement("div");
      hpT.style.position = "absolute";
      hpT.style.top = "-25px";
      hpT.style.fontSize = "18px";
      hpT.style.color = "#FF0000";
      hpT.style.fontWeight = "bold";
      hpT.style.textShadow = "0 0 5px #000";
      hpT.textContent = hp;
      z.appendChild(hpT);
      game.appendChild(z);

      const zombie = {
        r, 
        x: cols, 
        hp, 
        type: "thayma7", 
        speed: config.speed * 2,
        el: z, 
        hpT, 
        attack: null, 
        slow: 1,
        lastAttackTime: 0,
        attackDamage: config.attackDamage * 2,
        canAttack: config.canAttack,
        knockbackOnHit: config.knockbackOnHit,
        knockbackDistance: config.knockbackDistance * 2,
        attackInterval: config.attackInterval ? config.attackInterval / 2 : 500,
        config: config,
        isSuperBaronSpawn: true
      };

      zombies.push(zombie);
      
      z.style.boxShadow = "0 0 30px #FF0000";
      z.style.filter = "brightness(1.5)";
      setTimeout(() => {
        if (z.el) {
          z.el.style.boxShadow = "0 0 15px #FF0000";
          z.el.style.filter = "brightness(1.2)";
        }
      }, 1000);
      
      document.getElementById("boomSound").play();
      
    }, r * 500);
  }
}

function applyBaronBuffToThayma7() {
  const baronAlive = zombies.some(z => z.type === "thayma8");
  
  if (baronAlive && !thayma7Buffed) {
    zombies.forEach(z => {
      if (z.type === "thayma7") {
        if (!z.originalSpeed) {
          z.originalSpeed = z.speed;
          z.originalAttackInterval = z.attackInterval;
        }
        z.speed = z.originalSpeed * 2;
        if (z.originalAttackInterval) {
          z.attackInterval = z.originalAttackInterval / 2;
        }
        z.el.style.boxShadow = "0 0 15px #00FF00";
        z.el.style.filter = "brightness(1.3)";
      }
    });
    thayma7Buffed = true;
  } else if (!baronAlive && thayma7Buffed) {
    zombies.forEach(z => {
      if (z.type === "thayma7") {
        if (z.originalSpeed) {
          z.speed = z.originalSpeed;
        }
        if (z.originalAttackInterval) {
          z.attackInterval = z.originalAttackInterval;
        }
        z.el.style.boxShadow = "";
        z.el.style.filter = "";
      }
    });
    thayma7Buffed = false;
  }
}

// =============== SPAWN TH√ÇY MA TH√îNG MINH ===============
function spawnSmartZombie() {
  if (paused) {
    setTimeout(spawnSmartZombie, 1000);
    return;
  }
  if (plants.length === 0) {
    setTimeout(spawnSmartZombie, 5000);
    return;
  }
  let rowCount = new Array(rows).fill(0);
  plants.forEach(p => rowCount[p.r]++);
  const maxCount = Math.max(...rowCount);
  const candidates = [];
  rowCount.forEach((c, i) => {
    if (c === maxCount) candidates.push(i);
  });
  const targetRow = candidates[Math.floor(Math.random() * candidates.length)];
  const z = document.createElement("div");
  z.className = "zombie smart";
  const pos = cellPos(targetRow, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";
  
  const config = ZOMBIE_CONFIG.zombies.smart;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-20px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);
  
  const zombie = {
    r: targetRow,
    x: cols,
    hp,
    type: "smart",
    speed: config.speed,
    el: z,
    hpT,
    attack: null,
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: true,
    config: config
  };
  zombies.push(zombie);
  setTimeout(spawnSmartZombie, 5000);
}

// =============== SPAWN BOSS PURPLE ===============
function spawnBoss() {
  if (bossSpawned) return;
  bossSpawned = true;
  const r = Math.floor(rows / 2);
  const z = document.createElement("div");
  z.className = "zombie purple";
  const pos = cellPos(r, cols);
  z.style.left = pos.x + "px";
  z.style.top = pos.y + "px";
  
  const config = ZOMBIE_CONFIG.zombies.purple;
  const hp = config.baseHp;
  
  const hpT = document.createElement("div");
  hpT.style.position = "absolute";
  hpT.style.top = "-25px";
  hpT.textContent = hp;
  z.appendChild(hpT);
  game.appendChild(z);
  
  zombies.push({
    r,
    x: cols,
    hp,
    type: "purple",
    speed: config.speed,
    el: z,
    hpT,
    attack: null,
    slow: 1,
    lastAttackTime: 0,
    attackDamage: config.attackDamage,
    canAttack: true,
    config: config
  });
}

// =============== H√ÄM UPDATE CH√çNH ===============
function update() {
  if (paused) return;

  elapsedTime = Math.floor((Date.now() - startTime) / 1000);
  
  const minutes = Math.floor(elapsedTime / 60);
  const seconds = elapsedTime % 60;
  document.getElementById('timer').textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

  if (elapsedTime - lastUpdateTime >= ZOMBIE_CONFIG.timeUpdates.interval) {
    zombies.forEach(z => {
      if (z.type !== "thayma5" && z.type !== "thayma6" && z.type !== "thayma7" && z.type !== "thayma8") {
        z.hp += ZOMBIE_CONFIG.timeUpdates.hpIncrease;
        z.speed += ZOMBIE_CONFIG.timeUpdates.speedIncrease;
        z.hpT.textContent = Math.ceil(z.hp);
      }
    });
    lastUpdateTime = elapsedTime;
  }

  zombies.forEach(z => {
    if (z.type === "thayma6" && !z.hasStopped) {
      if (z.x <= cols - z.stopsAtDistance) {
        z.hasStopped = true;
        z.speed = 0;
      }
    }
    
    if (z.type === "thayma8" && !z.hasStopped) {
      if (z.x <= cols - z.stopsAtDistance) {
        z.hasStopped = true;
        z.speed = 0;
        z.el.style.boxShadow = "0 0 30px #8B0000";
      }
    }
    
    const targetPlant = plants.find(p => p.r === z.r && Math.abs(p.c - z.x) < 0.5);
    
    if (z.type === "thayma2" && z.passThroughPlants) {
      z.x -= z.speed * z.slow;
      const pos = cellPos(z.r, z.x);
      z.el.style.left = pos.x + "px";
    } else if (targetPlant) {
      let actualDamage = z.attackDamage;
      if (targetPlant.type === "cay14") {
        const config = targetPlant.config;
        actualDamage *= (1 - (config.action.damageReduction || 0));
      }
      
      if (targetPlant.type === "cay13") {
        z.x = Math.max(z.x, targetPlant.c + 0.5);
        const pos = cellPos(z.r, z.x);
        z.el.style.left = pos.x + "px";
      } else {
        if (z.type === "thayma3" && z.stopsAtPlant && !z.stopped) {
          const safeDistance = 0.8;
          if (Math.abs(targetPlant.c - z.x) <= safeDistance) {
            z.stopped = true;
            z.stuck = false;
            z.x = targetPlant.c - safeDistance;
            const pos = cellPos(z.r, z.x);
            z.el.style.left = pos.x + "px";
          }
        }
        
        if (z.canAttack && z.type !== "thayma3" && z.type !== "thayma6" && z.type !== "thayma8") {
          const now = Date.now();
          const attackInterval = z.attackInterval || ZOMBIE_CONFIG.attackInterval;
          
          if (now - z.lastAttackTime > attackInterval) {
            if (targetPlant.type === "cay16" && targetPlant.config.action.explosionOnHit) {
              const now = Date.now();
              if (now - targetPlant.lastHitTime > 1000) {
                const pos = cellPos(targetPlant.r, targetPlant.c);
                createMineExplosionEffect(pos.x, pos.y);
                document.getElementById("boomSound").play();
                
                const explosionDamage = targetPlant.config.action.explosionDamage || 30;
                zombies.forEach(zombie => {
                  if (!(zombie.type === "thayma6" && zombie.config.immuneToExplosion) && 
                      !(zombie.type === "thayma8" && zombie.config.immuneToExplosion)) {
                    zombie.hp -= explosionDamage;
                    zombie.el.style.boxShadow = "0 0 10px orange";
                    setTimeout(() => {
                      if (zombie.el) zombie.el.style.boxShadow = "";
                    }, 300);
                  }
                });
                
                targetPlant.el.classList.add("hit");
                setTimeout(() => {
                  if (targetPlant.el) targetPlant.el.classList.remove("hit");
                }, 500);
                targetPlant.lastHitTime = now;
              }
            }
            
            if (targetPlant.type === "cay17") {
              applyGarlicEffect(z, targetPlant);
              targetPlant.el.classList.add("garlic-hit");
              setTimeout(() => {
                if (targetPlant.el) targetPlant.el.classList.remove("garlic-hit");
              }, 500);
              document.getElementById("garlicSound").play();
            }
            
            if (targetPlant.type === "cay18") {
              const config = targetPlant.config.action.defenseEffect;
              applyExtremeSlow(z, config.extremeSlowAmount, config.extremeSlowDuration);
              targetPlant.el.classList.add("hit");
              setTimeout(() => {
                if (targetPlant.el) targetPlant.el.classList.remove("hit");
              }, 500);
              document.getElementById("throwSound").play();
            }
            
            targetPlant.hp -= actualDamage;
            targetPlant.hpT.textContent = Math.ceil(targetPlant.hp);
            z.lastAttackTime = now;
            
            if (z.type === "thayma7" && z.knockbackOnHit) {
              z.x += z.knockbackDistance || 1;
              const pos = cellPos(z.r, z.x);
              z.el.style.left = pos.x + "px";
              z.el.style.boxShadow = "0 0 15px red";
              setTimeout(() => {
                if (z.el) z.el.style.boxShadow = "";
              }, 300);
            }
            
            if (targetPlant.hp <= 0) {
              targetPlant.el.remove();
              plants = plants.filter(p => p !== targetPlant);
              z.attack = null;
              if (z.type === "thayma3") {
                z.stopped = false;
                z.stuck = false;
              }
            }
          }
        }
        
        if (z.canAttack || (z.type === "thayma3" && z.stopped) || (z.type === "thayma6" && z.hasStopped) || (z.type === "thayma8" && z.hasStopped)) {
          z.x = z.x;
        }
      }
    } else {
      if (!(z.type === "thayma3" && z.stopped) && !(z.type === "thayma6" && z.hasStopped) && !(z.type === "thayma8" && z.hasStopped)) {
        z.x -= z.speed * z.slow;
        const pos = cellPos(z.r, z.x);
        z.el.style.left = pos.x + "px";
        
        if (z.type === "thayma3") {
          z.stuck = false;
        }
      }
    }
    
    if (z.type === "thayma3" && z.stopped) {
      const currentTarget = plants.find(p => p.r === z.r && Math.abs(p.c - z.x) < 1.5);
      if (!currentTarget) {
        z.stopped = false;
        z.stuck = false;
      } else {
        z.stuck = false;
      }
    }
    
    if (z.type === "thayma6" && z.rangedAttack && z.hasStopped) {
      const now = Date.now();
      if (now - z.lastRangedAttack > z.rangedInterval) {
        const targetRow = Math.floor(Math.random() * 5);
        const bullet = document.createElement("div");
        bullet.className = "bullet red-boss-bullet";
        const pos = cellPos(targetRow, z.x);
        bullet.style.left = pos.x + "px";
        bullet.style.top = pos.y + "px";
        game.appendChild(bullet);
        bullets.push({ 
          r: targetRow, 
          x: z.x, 
          el: bullet, 
          power: z.rangedDamage,
          direction: -1,
          speed: 0.25,
          source: "zombie"
        });
        z.lastRangedAttack = now;
        document.getElementById("shootSound").play();
      }
    }
    
    z.hpT.textContent = Math.ceil(z.hp);
  });

  applyBaronBuffToThayma7();

  plants.forEach(p => {
    const now = Date.now();
    const config = p.config;
    
    if (p.type === "cay13") {
      if (now - p.lastHealTime > 1000) {
        p.hp = Math.min(p.maxHp, p.hp + (config.action.healPerSecond || 30));
        p.hpT.textContent = Math.ceil(p.hp);
        p.lastHealTime = now;
      }
    }
    
    if (p.type === "cay14") {
      if (now - p.lastSkillTime > (config.action.interval || 3000)) {
        let totalDamage = 0;
        const range = config.action.range || 1;
        zombies.forEach(z => {
          if (Math.abs(z.r - p.r) <= range && Math.abs(z.x - p.c) <= range) {
            z.hp -= config.action.damage;
            totalDamage += config.action.damage;
            z.el.style.boxShadow = "0 0 10px red";
            setTimeout(() => {
              if (z.el) z.el.style.boxShadow = "";
            }, 500);
          }
        });
        if (totalDamage > 0) {
          const healAmount = totalDamage * config.action.healMultiplier;
          plants.forEach(plant => {
            if (plant !== p) {
              const oldHp = plant.hp;
              plant.hp = Math.min(plant.maxHp || plant.hp, plant.hp + healAmount);
              plant.hpT.textContent = Math.ceil(plant.hp);
              if (plant.hp > oldHp) {
                const pos = cellPos(plant.r, plant.c);
                createHealEffect(pos.x, pos.y);
              }
            }
          });
          p.el.style.boxShadow = "0 0 20px gold";
          setTimeout(() => {
            if (p.el) p.el.style.boxShadow = "";
          }, 1000);
        }
        p.lastSkillTime = now;
      }
    }
    
    if (p.type === "cay16") {
      if (now - p.lastHealTime > 1000) {
        plants.forEach(plant => {
          if (plant !== p) {
            const oldHp = plant.hp;
            plant.hp = Math.min(plant.maxHp || plant.hp, plant.hp + (config.action.healPerSecond || 1));
            plant.hpT.textContent = Math.ceil(plant.hp);
            if (plant.hp > oldHp && Math.random() < 0.1) {
              const pos = cellPos(plant.r, plant.c);
              createHealEffect(pos.x, pos.y);
            }
          }
        });
        p.lastHealTime = now;
      }
    }
    
    if (p.type === "cay17") {
      if (now - p.lastAction > (config.action.interval || 2000)) {
        const bulletConfig = config.action.bullet;
        const b = document.createElement("div");
        b.className = "bullet " + bulletConfig.color;
        const pos = cellPos(p.r, p.c);
        b.style.left = (pos.x + 15) + "px";
        b.style.top = pos.y + "px";
        game.appendChild(b);
        bullets.push({
          r: p.r,
          x: p.c,
          el: b,
          power: bulletConfig.power,
          knock: bulletConfig.knock || false,
          knockDistance: bulletConfig.knockDistance || 0.5,
          direction: 1,
          enhanced: false,
          enhancedBy: [],
          maxRange: bulletConfig.range || 2,
          startX: p.c,
          source: "garlic",
          isProcessed: false
        });
        p.lastAction = now;
        document.getElementById("shootSound").play();
        createGarlicTrail(pos.x + 15, pos.y);
      }
    }
    
    if (p.type === "cay18") {
      if (now - p.lastAction > (config.action.interval || 3000)) {
        const bulletConfig = config.action.bullet;
        let targetZombie = null;
        let minDistance = Infinity;
        zombies.forEach(z => {
          if (z.r === p.r) {
            const distance = z.x - p.c;
            if (distance > 0 && distance < minDistance) {
              minDistance = distance;
              targetZombie = z;
            }
          }
        });
        if (!targetZombie && zombies.length > 0) {
          zombies.forEach(z => {
            const distance = Math.sqrt(Math.pow(z.r - p.r, 2) + Math.pow(z.x - p.c, 2));
            if (distance < minDistance) {
              minDistance = distance;
              targetZombie = z;
            }
          });
        }
        if (targetZombie) {
          const bullet = document.createElement("div");
          bullet.className = "bullet cay18-bullet";
          const startPos = cellPos(p.r, p.c);
          bullet.style.left = startPos.x + "px";
          bullet.style.top = startPos.y + "px";
          bullet.style.zIndex = "950";
          game.appendChild(bullet);
          const targetPos = cellPos(targetZombie.r, targetZombie.x);
          const startTime = Date.now();
          const duration = 1500;
          const throwHeight = bulletConfig.throwHeight || 60;
          const controlY = Math.min(startPos.y, targetPos.y) - throwHeight;
          const bulletObj = {
            el: bullet,
            startX: startPos.x,
            startY: startPos.y,
            targetX: targetPos.x,
            targetY: targetPos.y,
            controlY: controlY,
            startTime: startTime,
            duration: duration,
            mainDamage: bulletConfig.mainDamage,
            bounceDamage: bulletConfig.bounceDamage,
            bounceCount: bulletConfig.bounceCount,
            target: targetZombie,
            plant: p,
            isThrown: true,
            hasHit: false,
            bouncesCreated: 0,
            isProcessed: false
          };
          bullets.push(bulletObj);
          createThrowEffect(startPos.x, startPos.y);
          document.getElementById("throwSound").play();
          p.lastAction = now;
        }
      }
    }
    
    if (p.type === "cay15") {
      if (now - p.lastAction > (config.action.interval || 800)) {
        const bulletConfig = config.action.bullet;
        const b = document.createElement("div");
        b.className = "bullet " + bulletConfig.color;
        const pos = cellPos(p.r, p.c);
        b.style.left = (pos.x + 15) + "px";
        b.style.top = pos.y + "px";
        game.appendChild(b);
        bullets.push({
          r: p.r,
          x: p.c,
          el: b,
          power: bulletConfig.power,
          knock: bulletConfig.knock || false,
          direction: 1,
          enhanced: false,
          enhancedBy: [],
          isProcessed: false
        });
        p.lastAction = now;
        document.getElementById("shootSound").play();
      }
    }
    
    if (!config.action) return;
    if (p.cooldown) return;
    
    if (config.action.type === "sunProducer") {
      if (now - p.lastAction > config.action.interval) {
        sun += config.action.amount;
        sunSpan.textContent = sun;
        p.lastAction = now;
      }
    }
    
    if (config.action.type === "shooter") {
      if (now - p.lastAction > config.action.interval) {
        fireWithMana(p, () => {
          const bulletConfig = config.action.bullet;
          if (config.action.cost && sun >= config.action.cost) {
            sun -= config.action.cost;
            sunSpan.textContent = sun;
          }
          shoot(p, bulletConfig.count, bulletConfig.color, bulletConfig.power, 
                bulletConfig.freeze || false, bulletConfig.knock || false);
        });
      }
    }
  });

  bullets.forEach((b, index) => {
    if (b.isProcessed) return;
    
    if (b.direction === 1 && !b.source) {
      plants.forEach(p => {
        if (p.type === "cay12" && p.r === b.r && Math.abs(b.x - p.c) < 0.5) {
          const plantId = `${p.r}-${p.c}`;
          if (!b.enhancedBy) b.enhancedBy = [];
          if (!b.enhancedBy.includes(plantId)) {
            b.power *= 3;
            const currentWidth = parseInt(b.el.style.width) || 10;
            const currentHeight = parseInt(b.el.style.height) || 10;
            b.el.style.width = (currentWidth * 2) + "px";
            b.el.style.height = (currentHeight * 2) + "px";
            b.el.className += " enhanced";
            b.enhanced = true;
            b.enhancedBy.push(plantId);
          }
        }
      });
    }
    
    if (b.source === "garlic" && b.maxRange) {
      const distanceTraveled = b.x - b.startX;
      if (distanceTraveled >= b.maxRange) {
        if (b.el && b.el.parentNode) b.el.remove();
        bullets.splice(index, 1);
        return;
      }
    }
    
    if (b.isThrown && !b.hasHit) {
      const elapsed = Date.now() - b.startTime;
      const progress = Math.min(elapsed / b.duration, 1);
      const x = (1 - progress) * (1 - progress) * b.startX + 
                2 * (1 - progress) * progress * ((b.startX + b.targetX) / 2) + 
                progress * progress * b.targetX;
      const y = (1 - progress) * (1 - progress) * b.startY + 
                2 * (1 - progress) * progress * b.controlY + 
                progress * progress * b.targetY;
      b.el.style.left = x + "px";
      b.el.style.top = y + "px";
      if (progress >= 0.95 && b.target && !b.hasHit) {
        b.hasHit = true;
        b.isProcessed = true;
        b.target.hp -= b.mainDamage;
        applyPermanentSlow(b.target, b.plant.config.action.bullet.slowAmount, 
                          b.plant.config.action.bullet.maxSlow);
        if (b.bouncesCreated < b.bounceCount) {
          const targetPos = cellPos(b.target.r, b.target.x);
          for (let i = 0; i < b.bounceCount; i++) {
            setTimeout(() => {
              createBounceBullet(targetPos.x, targetPos.y, b.target, b.bounceDamage, b.plant);
            }, i * 200);
          }
          b.bouncesCreated = b.bounceCount;
        }
        setTimeout(() => {
          if (b.el && b.el.parentNode) b.el.remove();
          const bulletIndex = bullets.findIndex(bullet => bullet === b);
          if (bulletIndex !== -1) bullets.splice(bulletIndex, 1);
        }, 100);
        return;
      }
      if (progress >= 1) {
        b.isProcessed = true;
        if (b.el && b.el.parentNode) b.el.remove();
        bullets.splice(index, 1);
      }
      return;
    }
    
    if (b.isBounce && !b.hasHit) {
      const elapsed = Date.now() - b.startTime;
      const progress = Math.min(elapsed / b.duration, 1);
      const x = (1 - progress) * (1 - progress) * b.startX + 
                2 * (1 - progress) * progress * ((b.startX + b.targetX) / 2) + 
                progress * progress * b.targetX;
      const y = (1 - progress) * (1 - progress) * b.startY + 
                2 * (1 - progress) * progress * b.controlY + 
                progress * progress * b.targetY;
      b.el.style.left = x + "px";
      b.el.style.top = y + "px";
      if (progress >= 0.95 && b.target && !b.hasHit) {
        b.hasHit = true;
        b.isProcessed = true;
        b.target.hp -= b.damage;
        applyPermanentSlow(b.target, b.plant.config.action.bullet.slowAmount, 
                          b.plant.config.action.bullet.maxSlow);
        setTimeout(() => {
          if (b.el && b.el.parentNode) b.el.remove();
          const bulletIndex = bullets.findIndex(bullet => bullet === b);
          if (bulletIndex !== -1) bullets.splice(bulletIndex, 1);
        }, 100);
        return;
      }
      if (progress >= 1) {
        b.isProcessed = true;
        if (b.el && b.el.parentNode) b.el.remove();
        bullets.splice(index, 1);
      }
      return;
    }
    
    if (b.direction === -1) {
      b.x -= b.speed || 0.25;
      const pos = cellPos(b.r, b.x);
      b.el.style.left = pos.x + "px";
      let reflected = false;
      plants.forEach(p => {
        if (p.type === "cay11" && p.r === b.r && Math.abs(b.x - p.c) < 0.5 && !reflected) {
          p.hp -= 1;
          p.hpT.textContent = Math.ceil(p.hp);
          p.reflectionCount++;
          const newBullet = document.createElement("div");
          newBullet.className = b.el.className;
          const pos = cellPos(p.r, p.c);
          newBullet.style.left = pos.x + "px";
          newBullet.style.top = pos.y + "px";
          game.appendChild(newBullet);
          bullets.push({
            r: p.r,
            x: p.c,
            el: newBullet,
            power: b.power,
            direction: 1,
            speed: 0.2,
            source: "reflected",
            enhanced: b.enhanced,
            enhancedBy: b.enhancedBy ? [...b.enhancedBy] : [],
            isProcessed: false
          });
          reflected = true;
          if (b.el && b.el.parentNode) b.el.remove();
          bullets.splice(index, 1);
          if (p.hp <= 0) {
            sun += 1000;
            sunSpan.textContent = sun;
            p.el.remove();
            plants = plants.filter(pl => pl !== p);
          }
          return;
        }
      });
      if (!reflected) {
        let hitPlant = false;
        plants.forEach(p => {
          if (p.r === b.r && Math.abs(b.x - p.c) < 0.5 && !hitPlant && p.type !== "cay11") {
            p.hp -= b.power;
            p.hpT.textContent = Math.ceil(p.hp);
            hitPlant = true;
            if (p.hp <= 0) {
              p.el.remove();
              plants = plants.filter(pl => pl !== p);
            }
          }
        });
        if (hitPlant || b.x < 0) {
          if (b.el && b.el.parentNode) b.el.remove();
          bullets.splice(index, 1);
        }
      }
    } else {
      b.x += 0.2;
      const pos = cellPos(b.r, b.x);
      b.el.style.left = pos.x + "px";
      if (b.source === "garlic" && Math.random() < 0.3) {
        createGarlicTrail(pos.x, pos.y);
      }
      if (b.x > cols) {
        if (b.el && b.el.parentNode) b.el.remove();
        bullets.splice(index, 1);
      }
    }
  });

  bullets.forEach((b, index) => {
    if (b.isProcessed) return;
    if (b.direction === 1 && !b.isThrown && !b.isBounce) {
      let hitZombie = false;
      zombies.forEach(z => {
        if (z.type === "thayma5" || z.type === "thayma6" || z.type === "thayma7" || z.type === "thayma8") {
          let hitRange = (z.type === "purple" ? 1.2 : 0.3);
          if (z.r === b.r && Math.abs(z.x - b.x) < hitRange) {
            z.hp -= b.power;
            hitZombie = true;
          }
        } else {
          let hitRange = (z.type === "purple" ? 1.2 : 0.3);
          if (z.r === b.r && Math.abs(z.x - b.x) < hitRange) {
            if (z.type === "thayma3" && z.stuck) {
              z.stuck = false;
            }
            z.hp -= b.power;
            if (b.knockDistance && b.knock) {
              if (!z.immuneToKnockback) {
                z.x += b.knockDistance || 0.5;
                const pos = cellPos(z.r, z.x);
                z.el.style.left = pos.x + "px";
              }
            } else if (b.knock) {
              if (!z.immuneToKnockback) {
                z.x += 0.2;
              }
            }
            if (b.freeze && !z.frozen) { 
              if (!z.immuneToControl) {
                z.slow = Math.max(0.01, z.slow - 0.1); 
                z.frozen = true; 
              }
            }
            hitZombie = true;
          }
        }
      });
      if (hitZombie) {
        b.isProcessed = true;
        if (b.el && b.el.parentNode) b.el.remove();
        bullets.splice(index, 1);
      }
    }
  });

  zombies = zombies.filter(z => {
    if (z.hp <= 0) {
      document.getElementById("dieSound").play();
      const config = ZOMBIE_CONFIG.zombies[z.type];
      
      if (z.type === "thayma4" && z.explosionOnDeath) {
        document.getElementById("boomSound").play();
        zombies.forEach(otherZombie => {
          if (otherZombie.r === z.r && otherZombie !== z) {
            otherZombie.hp = 0;
          }
        });
      }
      
      if (z.type === "thayma6" && z.winOnKill) {
        alert("üéâ B·∫†N ƒê√É CHI·∫æN TH·∫ÆNG! ƒê√É TI√äU DI·ªÜT TH√ÇY MA T·ªêI TH∆Ø·ª¢NG! üéâ\nT·ªïng ƒëi·ªÉm: " + score);
        location.reload();
      }
      
      if (z.type === "thayma8") {
        thayma8Count--;
        if (z.spawnsThayma7OnDeath) {
          spawnSuperThayma7OnBaronDeath(z);
        }
        thayma7Buffed = false;
      }
      
      sun += config.sunReward;
      score += config.scoreReward;
      sunSpan.textContent = sun;
      scoreSpan.textContent = score;
      if (z.type === "red") {
        redKills++;
        if (redKills >= 20) spawnBoss();
      }
      if (z.type === "purple") {
        alert("üèÜ B·∫°n ƒë√£ chi·∫øn th·∫Øng! T·ªïng ƒëi·ªÉm: " + score);
        location.reload();
      }
      z.el.remove();
      return false;
    }
    if (z.x <= 0) {
      alert("üíÄ Zombie ƒë√£ v√†o nh√†! Game over! T·ªïng ƒëi·ªÉm: " + score);
      location.reload();
      return false;
    }
    return true;
  });

  plants = plants.filter(p => {
    if (p.hp <= 0) {
      if (p.type === "cay11") {
        sun += 1000;
        sunSpan.textContent = sun;
      }
      p.el.remove();
      return false;
    }
    return true;
  });

  bullets = bullets.filter(b => {
    if (b.isProcessed) return false;
    if (b.isThrown || b.isBounce) return true;
    return b.x < cols && b.x > -5;
  });
}

function fireWithMana(p, action) {
  if (p.cooldown) return;
  action();
  p.lastAction = Date.now();
  p.mana = Math.min(100, p.mana + 25);
  p.manaFill.style.width = p.mana + "%";
  if (p.mana >= 100) {
    p.cooldown = true;
    setTimeout(() => {
      p.mana = 0;
      p.manaFill.style.width = "0%";
      p.cooldown = false;
    }, 5000);
  }
}

function shoot(p, count, color, power, freeze, knock) {
  if (paused) return;
  document.getElementById("shootSound").play();
  for (let i = 0; i < count; i++) {
    const b = document.createElement("div");
    b.className = "bullet " + color;
    const pos = cellPos(p.r, p.c);
    b.style.left = (pos.x + 15 + i * 5) + "px";
    b.style.top = pos.y + "px";
    game.appendChild(b);
    bullets.push({
      r: p.r,
      x: p.c,
      el: b,
      power,
      freeze,
      knock,
      direction: 1,
      enhanced: false,
      enhancedBy: [],
      isProcessed: false
    });
  }
}

// =============== KH·ªûI ƒê·ªòNG GAME ===============
setInterval(update, 50);
setTimeout(spawnThayMa2, 1000);
setTimeout(spawnThayMa3, 1000);
setTimeout(spawnThayMa4, 1000);
setTimeout(spawnThayMa5, 1000);
setTimeout(spawnThayMa6, 1000);
setTimeout(spawnThayMa7, 1000);
setTimeout(spawnThayMa8, 1000);
setTimeout(spawnZombie, 2000);
setTimeout(spawnSmartZombie, 5000);
</script>
</body>
</html>